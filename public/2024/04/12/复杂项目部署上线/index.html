



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="杜明清的个人博客" href="https://dmqweb.cn/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="杜明清的个人博客" href="https://dmqweb.cn/atom.xml" />
<link rel="alternate" type="application/json" title="杜明清的个人博客" href="https://dmqweb.cn/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="复杂业务部署与优化" />


<link rel="canonical" href="https://dmqweb.cn/2024/04/12/%E5%A4%8D%E6%9D%82%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B8%8A%E7%BA%BF/">



  <title>
复杂业务部署与优化 - 复杂业务部署与优化 |
Web blog = 杜明清的个人博客 = 👻欢迎一起交流学习👻</title>
  <meta name="keywords" content="前端开发, HTML, CSS, JavaScript, 博客">
  <meta name="description" content="探索前端开发的无限可能。本博客提供最新的前端知识库，以及实用的开发技巧和最佳实践。加入我们的社区，共同成长。">
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">复杂业务部署与优化
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2024-04-12 08:33:58">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2024-04-12T08:33:58+08:00">2024-04-12</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Web blog</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://s3.uuu.ovh/imgs/2024/04/25/0aebf75866635811.jpg"></li>
          <li class="item" data-background-image="https://s3.uuu.ovh/imgs/2024/04/12/65788b6548e9e58f.jpg"></li>
          <li class="item" data-background-image="https://s3.uuu.ovh/imgs/2024/04/13/9404a557b00200f4.jpg"></li>
          <li class="item" data-background-image="https://s3.uuu.ovh/imgs/2024/03/29/4e134f025ae53f2b.jpg"></li>
          <li class="item" data-background-image="https://s3.uuu.ovh/imgs/2024/04/28/91b1bdcfda8d22da.webp"></li>
          <li class="item" data-background-image="https://s3.uuu.ovh/imgs/2024/04/28/dc01f095118914ac.webp"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%A4%8D%E6%9D%82%E4%B8%9A%E5%8A%A1%E9%83%A8%E7%BD%B2%E4%B8%8E%E4%BC%98%E5%8C%96/" itemprop="item" rel="index" title="分类于 复杂业务部署与优化"><span itemprop="name">复杂业务部署与优化</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://dmqweb.cn/2024/04/12/%E5%A4%8D%E6%9D%82%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B8%8A%E7%BA%BF/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="dmq">
    <meta itemprop="description" content="👻欢迎一起交流学习👻, ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="杜明清的个人博客">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="软件生命周期"><a class="anchor" href="#软件生命周期">#</a> 软件生命周期：</h1>
<p><img data-src="/images/Snipaste_2024-04-16_12-54-33.jpg" alt="/images/Snipaste_2024-04-16_12-54-33.jpg" /></p>
<h1 id="架构流程图"><a class="anchor" href="#架构流程图">#</a> 架构流程图</h1>
<p><img data-src="/images/Snipaste_2024-04-17_12-16-04.jpg" alt="/images/Snipaste_2024-04-17_12-16-04.jpg" /></p>
<h1 id="复杂项目通用方案"><a class="anchor" href="#复杂项目通用方案">#</a> 复杂项目通用方案</h1>
<h4 id="业务的复杂度"><a class="anchor" href="#业务的复杂度">#</a> 业务的复杂度</h4>
<ul>
<li>交互的复杂性</li>
<li>数据结构和状态的复杂性</li>
<li>多项目互相依赖的复杂性</li>
<li>打包</li>
<li>性能优化</li>
<li>第三方库的使用和调研以及二次开发</li>
</ul>
<h4 id="流程的复杂度"><a class="anchor" href="#流程的复杂度">#</a> 流程的复杂度</h4>
<ul>
<li>git flow</li>
<li>lint 工具</li>
<li>单元测试</li>
<li>commit 信息</li>
<li>PR revirew</li>
<li>CI / CD</li>
</ul>
<h1 id="ci-cd的概念"><a class="anchor" href="#ci-cd的概念">#</a> CI / CD 的概念</h1>
<p>业务组件库的开发和发布是随着一些列任务进化的：</p>
<ul>
<li>本地 commit 钩子函数完成 commit 验证</li>
<li>代码 push 到远端之后</li>
<li>跑特定的 test（不仅仅是本机的 unit test，也可能有时间很长的 E2E test）</li>
<li>test 通过之后检查是否有新的 tag，如果有就自动 publish 一个新的版本</li>
<li>甚至还有更多，自动部署文档站点等等。</li>
</ul>
<p>这些任务如果手动操作，就费时费力，所以需要自动化进行。</p>
<h4 id="cicontinuous-integration持续集成"><a class="anchor" href="#cicontinuous-integration持续集成">#</a> CI（Continuous integration）持续集成</h4>
<p>持续集成是指频繁地将代码集成到主干，一旦开发人员对应用所做的更改被合并，系统就会通过自动构建应用并运行不同级别的自动化测试（通常是单元测试和集成测试）来验证这些更改，确保这些更改没有对应用造成破坏。</p>
<p>作用有：</p>
<ul>
<li>快速发现错误</li>
<li>防止分支大幅偏离主干</li>
</ul>
<p>持续集成的目的就是让产品可以快速迭代，同时保持高质量。</p>
<h4 id="cdcontinuous-delivery持续交付"><a class="anchor" href="#cdcontinuous-delivery持续交付">#</a> CD（Continuous Delivery）持续交付</h4>
<p>持续交付是指频繁地将软件的新版本，交付给质量团队或者用户，以供评审。</p>
<h4 id="cdcontinuous-deployment持续部署"><a class="anchor" href="#cdcontinuous-deployment持续部署">#</a> CD（Continuous Deployment）持续部署</h4>
<p>持续部署是持续交付的下一步，指的是代码通过评审以后，自动部署到生产环境。</p>
<h4 id="ci-cd两大服务"><a class="anchor" href="#ci-cd两大服务">#</a> CI / CD 两大服务：</h4>
<ul>
<li>github actions</li>
<li>travis-ci</li>
</ul>
<h1 id="列表排序解决方案"><a class="anchor" href="#列表排序解决方案">#</a> 列表排序解决方案</h1>
<p>列表排序原理：</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span>template<span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token operator">&lt;</span>div<span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token operator">&lt;</span>ul <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"ul"</span> @drop<span class="token operator">=</span><span class="token string">"onDrop"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token operator">&lt;</span>li </pre></td></tr><tr><td data-num="5"></td><td><pre>            v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"(item,index) in list"</span> </pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token operator">:</span>data<span class="token operator">-</span>index<span class="token operator">=</span><span class="token string">"index"</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token operator">:</span>key<span class="token operator">=</span><span class="token string">"item.id"</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>            @dragover<span class="token operator">=</span><span class="token string">"onDragover($event,index)"</span> </pre></td></tr><tr><td data-num="9"></td><td><pre>            @dragstartart<span class="token operator">=</span><span class="token string">"dragstart($event,index)"</span> </pre></td></tr><tr><td data-num="10"></td><td><pre>            @dragenter<span class="token operator">=</span><span class="token string">"dragenter($event,index)"</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>            draggable<span class="token operator">=</span><span class="token string">"true"</span> </pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token operator">:</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"[item.id==currentLi?'glost':'']"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>swig￼<span class="token number">0</span><span class="token operator">--</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">></span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token operator">&lt;</span>script setup<span class="token operator">></span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">/*eslint-disable*/</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> ref <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"vue"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>arrayMoveImmutable<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'array-move'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">let</span> currentLi <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">const</span> list <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#123;</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'列表1'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token punctuation">&#123;</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'列表2'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token punctuation">&#123;</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'列表3'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token punctuation">&#123;</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'列表4'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token punctuation">&#123;</span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'列表5'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">dragstart</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span>inde</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  currentLi<span class="token punctuation">.</span>value <span class="token operator">=</span> inde<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">dragenter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span>ind</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">if</span><span class="token punctuation">(</span>ind <span class="token operator">!=</span> currentLi<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      list<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">arrayMoveImmutable</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span>value<span class="token punctuation">,</span>ind<span class="token punctuation">,</span>currentLi<span class="token punctuation">.</span>value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      currentLi<span class="token punctuation">.</span>value <span class="token operator">=</span> ind<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">onDrop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>index<span class="token punctuation">,</span><span class="token string">'drop'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  list<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">arrayMoveImmutable</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span>value<span class="token punctuation">,</span>index<span class="token punctuation">.</span>value<span class="token punctuation">,</span>currentLi<span class="token punctuation">.</span>value<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">onDragover</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span>inde</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>  e<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  index<span class="token punctuation">.</span>value <span class="token operator">=</span> inde<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token operator">&lt;</span>style  scoped<span class="token operator">></span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">.</span>ul<span class="token operator">></span>li<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token literal-property property">height</span><span class="token operator">:</span> 50px<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token literal-property property">border</span><span class="token operator">:</span> 1px solid red<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token punctuation">.</span>glost<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  box<span class="token operator">-</span>shadow<span class="token operator">:</span> 10px 10px 3px 3px gray<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">></span></pre></td></tr></table></figure><p>列表排序常用工具包：</p>
<ul>
<li>vue-draggable</li>
<li>sortable.js</li>
<li>array-move.js</li>
</ul>
<h1 id="拖动改变位置原理"><a class="anchor" href="#拖动改变位置原理">#</a> 拖动改变位置原理</h1>
<p>通过监听 mousedown 和 mousemove 事件，用 element.getBoundingClientRect 方法获得 x 和 y，left 和 top 等属性，改变对应元素的 top 和 left 属性。</p>
<h1 id="拖动改变大小原理"><a class="anchor" href="#拖动改变大小原理">#</a> 拖动改变大小原理</h1>
<p>设置边框元素，边框元素的四个角添加圆点元素，监听 mousedown 事件和 mousemove 事件，并将最新的坐标赋值给元素的尺寸大小。</p>
<h1 id="快捷键实现原理"><a class="anchor" href="#快捷键实现原理">#</a> 快捷键实现原理</h1>
<p>好用的快捷键第三方库：Hotkeys.js</p>
<p>事件原理：keydown 事件的监听，通过 event.key 判断是那个快捷键，从而执行对应的操作。</p>
<h1 id="撤销重做原理"><a class="anchor" href="#撤销重做原理">#</a> 撤销重做原理</h1>
<p>维护一个固定长度的 histories 数组和 historyIndex 指针，每次修改的时候添加一条记录（标识操作类型和数据）。回滚时改变 historyIndex 指针。</p>
<h1 id="右键菜单原理"><a class="anchor" href="#右键菜单原理">#</a> 右键菜单原理</h1>
<p>在需要显示的区域拦截默认的右键点击事件，判断是否点击在组件元素上（通过 event.target），显示一个自定义菜单，其中包括操作项，显示在鼠标的位置（event.clientX 和 event.clientY），点击完成操作，通过 display:none 隐藏。</p>
<h1 id="自动保存实现方案"><a class="anchor" href="#自动保存实现方案">#</a> 自动保存实现方案</h1>
<ul>
<li>定时保存（语雀）</li>
<li>实时保存（石墨）</li>
</ul>
<p>实现原理：添加 isDrity 字段标记数据是否有修改，当修改时将 isDirty 设置为 true，根据 isDIrty 的值设置定时器，定时触发保存逻辑。</p>
<h1 id="dom元素截图实现方案"><a class="anchor" href="#dom元素截图实现方案">#</a> DOM 元素截图实现方案</h1>
<p>工具包：html2canvas</p>
<p>实现原理：</p>
<p>根据 DOM 元素的 styles 样式，通过 svg 的 foreignObject 元素引入 XML 命名空间的元素，然后创建一个 image 标签，将 svg 通过 url.createObjectURL 方法创建一个路径赋值给一个 image 标签的 src 属性，通过 canvas 画笔 的 drawImage 方法将 image 图片绘制到 canvas 画布上。</p>
<p>实现流程：</p>
<ul>
<li>style 设置 DOM 样式</li>
<li>svg 引入 DOM</li>
<li>createObjectURL 创建 url 路径</li>
<li>将 url 复制到 image 标签的 src</li>
<li>canvas 的 drawImage 将 image 图片绘制到 canvas 画布上</li>
</ul>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> data <span class="token operator">=</span></pre></td></tr><tr><td data-num="2"></td><td><pre>"<span class="token operator">&lt;</span>svg xmlns<span class="token operator">=</span><span class="token string">'http://www.w3.org/2000/svg'</span>width<span class="token operator">=</span><span class="token string">'400px'</span>height<span class="token operator">=</span>'<span class="token number">40</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token string">"&lt;foreignabject width='100%'height='100%'>"</span><span class="token operator">+</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token string">"&lt;div xmlns='http://ww.w3.org/1999/xhtml'>"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>element<span class="token punctuation">.</span>innerHTML<span class="token operator">+</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token string">"&lt;/div>"</span><span class="token operator">+</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token string">"&lt;/foreignobject>"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token string">"&lt;/svg>"</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">const</span> svg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>data<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token string">"image/svg+xml;charset=utf-8"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createobjectURL</span><span class="token punctuation">(</span>svg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>image<span class="token punctuation">.</span>src <span class="token operator">=</span> url</pre></td></tr><tr><td data-num="14"></td><td><pre>image<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">const</span> ctx <span class="token operator">=</span>anvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    ctx<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="二维码生成方案"><a class="anchor" href="#二维码生成方案">#</a> 二维码生成方案</h1>
<ul>
<li>工具包：node-qrcode</li>
<li>ts 项目中需要安装额外的定义文件。</li>
</ul>
<p>简单原理：将数据变为二进制，然后通过 canvas 将二进制变为图像。</p>
<figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>canvas</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>qrcode<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>128<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>128<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>canvas</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript"></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 将字符串转为二进制形式</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">toBianary</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">let</span> res <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>str<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">let</span> charCode <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">let</span> binaryCharCode <span class="token operator">=</span> charCode<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            res <span class="token operator">+=</span> binaryCharCode<span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> res<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 绘制</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">function</span> <span class="token function">drawQRCode</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> canvas</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token keyword">var</span> context <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">"2d"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token comment">// 绘制黑白像素点</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> text<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">var</span> row <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>i <span class="token operator">/</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">var</span> col <span class="token operator">=</span> i <span class="token operator">%</span> canvas<span class="token punctuation">.</span>width<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">var</span> color <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"1"</span> <span class="token operator">?</span> <span class="token string">"#000000"</span> <span class="token operator">:</span> <span class="token string">"#FFFFFF"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        context<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> color<span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="23"></td><td><pre>        context<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> row<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">var</span> qrcodeCanvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"qrcode"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token function">drawQRCode</span><span class="token punctuation">(</span><span class="token function">toBianary</span><span class="token punctuation">(</span><span class="token string">'https://dmqweb.cn'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> qrcodeCanvas<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 示例：绘制一个简单的二维码</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h1 id="复制功能实现原理"><a class="anchor" href="#复制功能实现原理">#</a> 复制功能实现原理</h1>
<ul>
<li>工具包：clipboard.js</li>
<li>自带 type 定义文件</li>
</ul>
<p>实现原理：</p>
<p>方案一：document.execCommand () 方法。内置一系列功能，包括复制文本（但<strong>前提是需要选中文本</strong>），可以使用不可见元素迂回。</p>
<p>方案二：Clipboard API（ navigator.clipboard ），但是对于<strong>浏览器兼容性有待加强。</strong></p>
<h1 id="下载文件原理"><a class="anchor" href="#下载文件原理">#</a> 下载文件原理</h1>
<ul>
<li>工具包：FileSaver.js（小文件）</li>
<li>StreamSaver.js（大文件）</li>
</ul>
<p>方案一：超链接 a 标签添加 download 属性，属性值为文件名，rel 属性设置打开页面的具体实现细节。（但前提是<strong> href 属性为当前同源情况下</strong>。）</p>
<p>方案二：通过 axios 请求到图片地址，通过 URL.createObjectURL 创建为一个与 document 相绑定的地址，赋值给 a 标签即可。（不要忘记使用 URL.revokeObjectURL 将创建的地址移除。）</p>
<p>方案三：通过 FileReader.readAsDataURL，创建一个 FileReader 实例，使用 readAsDataURL 读取对象返回一段 base64 格式的字符串，监听 reader 实例的 onload 事件，创建 a 标签将 reader.result 赋值给 a 标签的 href 属性。</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function-variable function">downloadFile</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span>fileName</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>   <span class="token keyword">const</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token comment">// 传入被读取的 blob 对象</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   reader<span class="token punctuation">.</span><span class="token function">readAsDataURL</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token comment">// 读取完成的回调事件</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   reader<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>       <span class="token keyword">let</span> a <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>       a<span class="token punctuation">.</span>download <span class="token operator">=</span> fileName</pre></td></tr><tr><td data-num="9"></td><td><pre>       a<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">'none'</span></pre></td></tr><tr><td data-num="10"></td><td><pre>       <span class="token comment">// 生成的 base64 编码</span></pre></td></tr><tr><td data-num="11"></td><td><pre>       <span class="token keyword">let</span> url <span class="token operator">=</span> reader<span class="token punctuation">.</span>result</pre></td></tr><tr><td data-num="12"></td><td><pre>       a<span class="token punctuation">.</span>href <span class="token operator">=</span> url</pre></td></tr><tr><td data-num="13"></td><td><pre>       document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>       a<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>       document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>终极解决方案：由于通过 URL.createObjectURL 和 FileReader 都会先将数据保存到内存中，业务中经常需要后端验证 token 之后才能拿到文件，不能直接使用 a 标签。因此实际中可以先发送 ajax 请求验证 token，验证之后颁发一个过期时间短的 cookie，之后使用 a 标签进行下载即可。但是同样会受到 a 标签 download 属性跨域请求的限制。</p>
<h1 id="应用部署的流程"><a class="anchor" href="#应用部署的流程">#</a> 应用部署的流程</h1>
<p><strong>构建</strong><br />
 Javascript 语言本身是不需要编译的。<br />
但是现代的前端项目使用的语言和或者的模块系统都无法在浏览器中使用，都需要使用特定的<br />
 bundler 将源代码最终转换为浏览器支持的 Javascript 代码。<br />
<strong>不同的环境:</strong><br />
 开发环境 (development) ：本地的测试环境<br />
测试环境 (test 或者 staging）：线上的测试环境</p>
<p>生产环境（production)：线上的生产环境</p>
<p><strong>生产和开发环境的区别</strong><br />
开发环境会添加丰富的错误提示，可以使用 mock server 或者本地后端环境添加各种便利的功能 - 比如 hot reload, 自动刷新，不太关心静态资源的大小，最好提供最丰富的调试信息 (sourcemap) 等。</p>
<p><strong>生产环境</strong></p>
<ul>
<li>稳定是最重要的原则</li>
<li>速度是第一要务</li>
</ul>
<p><strong>生产环境和测试环境的区别</strong></p>
<ul>
<li>高度相似</li>
<li>使用的后端服务不一样</li>
</ul>
<p><strong>环境变量设置（按优先级）</strong></p>
<ul>
<li>跨平台设置环境变量工具包：cross-env</li>
<li>命令中添加环境变量（平台限制）</li>
<li>环境变量文件中配置</li>
</ul>
<p><strong>在项目根目录中放置下列文件来指定环境变量</strong></p>
<ul>
<li>.env                                        #在所有的环境中被载入</li>
<li>.env.local                             #在所有的环境中被载入，但会被 git 忽略</li>
<li>env.[mode]                         #只在指定的模式中被载入</li>
<li>env.[mode].local             #只在指定的模式中被载入，但会被 git 忽略</li>
</ul>
<h1 id="webpack构建优化"><a class="anchor" href="#webpack构建优化">#</a> webpack 构建优化</h1>
<h3 id="bundler"><a class="anchor" href="#bundler">#</a> Bundler：</h3>
<ul>
<li>
<p>将浏览器不支持的模块进行编译，转换，</p>
</li>
<li>
<p>合并最后生成的代码可以在浏览器端良好的运行的工具。</p>
</li>
</ul>
<h3 id="loaders"><a class="anchor" href="#loaders">#</a> <strong><span class="exturl" data-url="aHR0cHM6Ly93ZWJwYWNrLmRvY3NjaGluYS5vcmcvY29uY2VwdHMvbG9hZGVycy8=">Loaders</span>：</strong></h3>
<p>loader 用于对模块的源代码进行转换。loader 可以使你在 import 或 &quot;Ioad (加载)&quot; 模块时预处理文件。<br />
<strong>多个 Loader</strong><br />
module.rules 允许你在 webpack 配置中指定多个 loader。这种方式是展示 loader 的一种简明方式，并且有助于使代码变得简洁和易于维护。</p>
<p><strong>webpack 中 loader 配置：</strong></p>
<figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>const path = require('path')</pre></td></tr><tr><td data-num="2"></td><td><pre>module.exports = <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    entry<span class="token operator">:</span>'./main.js'<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    output<span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        path<span class="token operator">:</span>path.resolve(dirname<span class="token punctuation">,</span>'dist')<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        filename<span class="token operator">:</span>bundle.js'<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>module<span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    rules<span class="token operator">:</span><span class="token punctuation">[</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        test<span class="token operator">:</span>/\.css$/<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        use<span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            loader<span class="token operator">:</span>'style-loader'<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token comment">// 先写的 loader 后执行。</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            loader<span class="token operator">:</span>'css-loader'<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h6 id="原理"><a class="anchor" href="#原理">#</a> 原理</h6>
<p><strong>webpack 中 loader 原理：</strong></p>
<p>在 webpack.config.js 的 module 字段的 rules 数组中进行配置：添加一个对象标识一个独立的匹配项，test 字段使用正则表示匹配的文件名，use 数组表示对应文件需要执行的 loader，webpack 在打包时会<strong>将文件内容传入并执行对应的 loader</strong>（是一个函数），<strong>执行 loader 函数后会将函数返回值包装成一个新的函数</strong>，因此 webpack 中的 loader 通常需要进行两次 module.exports。</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 手写一个 md 文件的 loader</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> marked <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'marked'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 第三方库，用于将 md 转为 html</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> utils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'loader-utils'</span><span class="token punctuation">)</span>  <span class="token comment">// 官方库，用于获取用户配置 loader 时传入的参数</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">markdownLoader</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">const</span> options <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">marked</span><span class="token punctuation">(</span>source <span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span>  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> markdownLoader<span class="token punctuation">;</span></pre></td></tr></table></figure><p>配置：</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token literal-property property">entry</span><span class="token operator">:</span><span class="token string">'./main.js'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token literal-property property">output</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token literal-property property">path</span><span class="token operator">:</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token literal-property property">filename</span><span class="token operator">:</span>bundle<span class="token punctuation">.</span>js'<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token literal-property property">module</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token literal-property property">rules</span><span class="token operator">:</span><span class="token punctuation">[</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">&#123;</span> <span class="token literal-property property">loader</span><span class="token operator">:</span><span class="token string">'style-loader'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token comment">// 先写的 loader 后执行。</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token punctuation">&#123;</span> <span class="token literal-property property">loader</span><span class="token operator">:</span><span class="token string">'css-loader'</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token literal-property property">test</span><span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.md$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#123;</span> <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'./markdonwn-loader'</span><span class="token punctuation">,</span><span class="token literal-property property">options</span><span class="token operator">:</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">headerIds</span><span class="token operator">:</span><span class="token boolean">false</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 其中 options 是给 loader 函数传入的第二个参数，loader 中可以使用 loader-utils 官方三方库进行接受</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>多个 Loader 串联</strong><br />
最后的 loader 最早调用，将会传入原始资源内容。<br />
第一个 loader 最后调用，期望值是传出 JavaScript 和 source map (可选)。<br />
中间的 loader 执行时，会传入前一个 loader 传出的结果。<br />
<strong>将 markdown 转换为 html:turndown</strong><br />
 地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIub20vZG9tY2hyaXN0aWUvdHVybmRvd24=">https://github.om/domchristie/turndown</span></p>
<h3 id="plugins"><a class="anchor" href="#plugins">#</a> <strong>plugins:</strong></h3>
<p><span class="exturl" data-url="aHR0cHM6Ly93ZWJwYWNrLmRvY3NjaGluYS5vcmcvY29uY2VwdHMvcGx1Z2lucy8=">https://webpack.docschina.org/concepts/plugins/</span><br />
 插件是 webpack 的支柱功能。webpack 自身也是构建开你在 webpack 配置中用到的相同的插件系统之上！插件目的在于解决 loader 无法实现的其他事。(我自己的理解，loader 解决的是各种不同资源的问题，plugins 更多解决的是项目整体的事情)</p>
<figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre>const path = require('path');</pre></td></tr><tr><td data-num="2"></td><td><pre>const HtmlWebpackPlugin = require('html-webpack-plugin');</pre></td></tr><tr><td data-num="3"></td><td><pre>module.exports = <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    entry<span class="token operator">:</span>'./main.js'<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    output<span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        path<span class="token operator">:</span>path.resolve(dirname<span class="token punctuation">,</span>'dist')<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        filename<span class="token operator">:</span>bundle.js'<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>module<span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    rules<span class="token operator">:</span><span class="token punctuation">[</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        test<span class="token operator">:</span>/八.css$/<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        use<span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            loader<span class="token operator">:</span>'style-loader'<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token comment">// 先写的 loader 后执行。</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            loader<span class="token operator">:</span>'css-loader'<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>plugins<span class="token operator">:</span><span class="token punctuation">[</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    new BundlesizeWebpackPlugin( <span class="token punctuation">&#123;</span> sizeLimit<span class="token operator">:</span><span class="token number">3</span> <span class="token punctuation">&#125;</span> )  <span class="token comment">// 自己手写的插件（如下）</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    new webpack.ProgressPlugin()<span class="token punctuation">,</span> <span class="token comment">// 显示打包过程（webpack 内置插件）</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    new HtmlwebpackPlugin()<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h6 id="原理-2"><a class="anchor" href="#原理-2">#</a> 原理</h6>
<p><strong>webpack 中 plugins 原理：</strong></p>
<p>webpack 执行时会将 plugins 字段中的插件实例取出并将 webpack 实例传入并执行其<strong> apply 方法</strong>，通过 webpack 实例的 hooks 中的方法我们可以操控对应的钩子函数。</p>
<p>官方的教程：<span class="exturl" data-url="aHR0cHM6Ly93ZWJwYWNrLmpzLm9yZy9jb250cmlidXRlL3dyaXRpbmctYS1wbHVnaW4v">https://webpack.js.org/contribute/writing-a-plugin/</span><br />
<strong> 插件的格式</strong><br />
一个 JavaScript 函数或 JavaScript 类 ，在它原型上定义的 apply 方法，会在安装插件时被调用，并被 webpack compiler 调用一次。指定一个触及到 webpack 本身的事件钩子，即 hooks, 用于特定时机处理额外的逻辑<br />
 Compiler Hooks 列表<br />
<span class="exturl" data-url="aHR0cHM6Ly93ZWJwYWNrLmlzLm9yZy9hcGkvY29tcGlsZXItaG9va3Mv"> https://webpack.is.org/api/compiler-hooks/</span></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 手写一个 webpack 插件，打包文件超出限制时，报错。</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> resolve <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> statSync <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//fs 模块中同步读取文件信息</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">BundlesizeWebpackPlugin</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// 获取到传入的参数</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> sizeLimit <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compile<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'BundleSizePlugin'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">compilationParams</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span> <span class="token comment">// 编译时钩子，参数是参数</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'compile阶段'</span><span class="token punctuation">,</span>compilationParams<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'BundleSizePlugin'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span> <span class="token comment">// 结束时钩子，参数是打包后的信息。</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">,</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">// 拿到打包后文件的路径和文件名</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> path <span class="token punctuation">,</span> filename <span class="token punctuation">&#125;</span> <span class="token operator">=</span> stats<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span>outputOptions<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// 拼接成文件路径</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">const</span> bundlePath <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token comment">// 获取到文件 size</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> size <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">statSync</span><span class="token punctuation">(</span>bundlePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">const</span> bundleSize <span class="token operator">=</span> size <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">if</span><span class="token punctuation">(</span>bundleSize <span class="token operator">&lt;</span> sizeLimit<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Safe:Bundle-Size'</span><span class="token punctuation">,</span>bundleSize<span class="token punctuation">,</span><span class="token string">'\n Size Limit:'</span><span class="token punctuation">,</span>sizeLimit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Unsafe:Bundle-Size'</span><span class="token punctuation">,</span>bundleSize<span class="token punctuation">,</span><span class="token string">'\n Size Limit:'</span><span class="token punctuation">,</span>sizeLimit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> BundlesizeWebpackPlugin<span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="总结"><a class="anchor" href="#总结">#</a> 总结</h3>
<p><strong>Loaders 关注代码中的单个资源，Plugins 关注整体流程，可以接触到 webpack 构建流程中的<br />
各个阶段并劫持做一些代码处理。</strong></p>
<h1 id="node后端框架"><a class="anchor" href="#node后端框架">#</a> node 后端框架</h1>
<h2 id="nodejs后端框架调研"><a class="anchor" href="#nodejs后端框架调研">#</a> Node.js 后端框架调研</h2>
<p><strong>后端框架应该注意的三大问题</strong><br />
路由 Routes<br />
 请求 Request<br />
 响应 Response</p>
<h4 id="express"><a class="anchor" href="#express">#</a> Express</h4>
<p>官方网址：[https:l/expressis.com (https:expressis.com)<br />
<strong> 安装</strong><br />
官方网址：[<span class="exturl" data-url="aHR0cHM6Ly9leHByZXNzaXMuY29tL3poLWNuL3N0YXJ0ZXIvaW5zdGFsbGluZy5odG1s">https://expressis.com/zh-cn/starter/installing.html</span>](https:l/expressjs.com/zh-<br />
cn/starter/installing.html)<br />
 使用生成器安装，可以自动生成一系列的脚手架代码：[https:/expressjs.com/zh<br />
cn/starter/generator.htmll(<span class="exturl" data-url="aHR0cHM6Ly9leHByZXNzaXMuY29tL3poLWNuL3N0YXJ0ZXIvZ2VuZXJhdG9yLmh0bWw=">https://expressis.com/zh-cn/starter/generator.html</span>)</p>
<p><strong>优点</strong></p>
<p>快速简单、易上手</p>
<p><strong>缺点</strong></p>
<ul>
<li>路由响应中，很可能有：从外部请求数据的服务，有验证路由的请求参数，返回特定的格式。</li>
<li>所有逻辑不分青红皂白的写在一起！很容易产生冗长的难以维护的代码。</li>
<li>一些大型必备的模块，如第三方服务初始化，安全，日志都没有明确的标准。</li>
</ul>
<p><strong>Express 中间件：</strong></p>
<p>Express 是一个基于中间件的框架，其余任务都会在中间件中执行，中间件是一个队列结构，先写入的任务先执行，中间件的写法是：app.use ()，当调用中间件时，会向传入的函数中传入 req,res 和 next 函数。</p>
<p><strong>中间件可以完成的任务</strong></p>
<ul>
<li>执行任何代码。</li>
<li>对请求和响应对象进行更改。</li>
<li>结束请求 / 响应循环。</li>
<li>调用堆栈中的下一个中间件。</li>
</ul>
<h4 id="koa2"><a class="anchor" href="#koa2">#</a> Koa2</h4>
<p><strong>官网地址</strong>：[https:I/koajs.com (https:/koajs.com)</p>
<p><strong>Koa2 和 Express 的区别</strong></p>
<ul>
<li>使用 Promise (async,await) 代替 callback (node&gt;v7.6.0)</li>
<li>使用 ctx (上下文对象) 封装 req (Request) 和 res (Response), 以及一些常用的功能。</li>
<li><strong>完全不同的中间件机制</strong></li>
<li><strong>更轻量级，没有捆绑任何中间件</strong></li>
<li>官方文章：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2tvYWpzL2tvYS9ibG9iL21hc3Rlci9kb2NzL2tvYS12cy1leHByZXNzLm1k">https://github.com/koajs/koa/blob/naster/docs/koa-vs-express.md</span></li>
</ul>
<p><strong>Koa2 中间件：</strong></p>
<ol>
<li>Koa2 中间件，由 Express 的队列模型（同步）转变为洋葱模型，当程序运行到 <code>await next()</code>  的时候就会暂停当前程序，进入下一个中间件，处理完之后才会仔回过头来继续处理。</li>
<li>Koa2 洋葱模型解决的问题就是一个中间件可以调用其他中间件执行后，再继续自己的操作，Express 框架中 next () 执行后就直接到下一个中间件操作，无法退回。</li>
</ol>
<p><img data-src="/images/Snipaste_2024-04-22_14-30-49.jpg" alt="Koa2中间件" /></p>
<p><strong>代码示例：</strong></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> <span class="token constant">PORT</span> <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>Koa2 特点：</strong></p>
<ul>
<li>响应机制的不同</li>
<li>Express: 我们直接操作的是 res 对象，直接 res.send 之后就立即响应了。</li>
<li>Koa2: 数据的响应是通过 ctx.body 进行设置，注意这里仅是设置并没有立即响应，而是在所有的中间件结束之后做了响应。</li>
</ul>
<p>** 缺点：**Koa2 在使用上有一定的缺点，因为太过于轻量使得在使用时需要手动处理很多操作，可以使用基于 Koa2 的上层框架（如：egg.js）</p>
<h4 id="eggjs"><a class="anchor" href="#eggjs">#</a> egg.js</h4>
<p><strong>Express 和 Koa2 的不足</strong></p>
<ul>
<li>简单而且扩展性强，适合个人的比较小的项目</li>
<li>没有约定，对于统一维护和开发非常不利</li>
</ul>
<p><strong>对于后端框架的需求</strong></p>
<ul>
<li>需要有一套优秀的统一的约定或者架构进行开发</li>
<li>有丰富的扩展机制和可定制性</li>
<li>Typescript 支持</li>
</ul>
<p><strong>egg.js</strong></p>
<ul>
<li>地址：[https:l/eggis.org/zh-cnI (https:l/eggjs.org/zh-cn) （基于 Koa2）</li>
<li>阿里大厂出品，维护有保障。国内开发者开发，中文文档质量有保证。</li>
<li><strong>约定优于配置，按照一套统一的约定进行应用开发。</strong></li>
<li>一个插件只做一件事，高度可扩展的插件机制</li>
<li>支持 Typescript</li>
</ul>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>//nodejs版本10以上</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">npm</span> init egg <span class="token parameter variable">--type</span><span class="token operator">=</span>ts</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">npm</span> <span class="token function">install</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">npm</span> run dev</pre></td></tr></table></figure><p><strong>egg.js 概念：</strong></p>
<ul>
<li>
<p>Application - 全局应用对象，只有一个实例。</p>
</li>
<li>
<p>Context - 上下文对象，每次请求生成一个实例。</p>
</li>
<li>
<p>Request - 请求对象，来自 Koa。</p>
</li>
<li>
<p>Response - 响应对象，来自 Koa 的一个新的对象。</p>
</li>
<li>
<p>Helper - 用来提供一些实用的 utility 函数。框架内置了几个简单的 Helper 函数。</p>
</li>
</ul>
<h4 id="nestjs"><a class="anchor" href="#nestjs">#</a> Nest.js</h4>
<ul>
<li>地址：<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm5lc3Rqcy5jbg==">https:/docs.nestjs.com</span></li>
<li>内置并且完全支持 Typescript</li>
<li>开箱即用的应用程序架构</li>
<li>可扩展，松散耦合</li>
<li>大量采用了装饰器的写法 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm5lc3Rqcy5jbi8xMC9vcGVuYXBpP2lkPSVlOCVhMyU4NSVlOSVhNSViMCVlNSU5OSVhOA==">Nest.js 装饰器</span></li>
</ul>
<h1 id="vueconfigjs"><a class="anchor" href="#vueconfigjs">#</a> vue.config.js</h1>
<p><strong>个性化构建结果 - vue.config,js</strong><br />
 在基础的配置上，自定义构建的结果 - 可以使用 vue.config.js<br />
 文档地址：https:l/cli.vuejs.org/zh/config#vue-config-js<br />
 简介两个字段<br />
<strong> PublicPath</strong> - 部署应用包时的基本 URL, 这个配置对应的是 webpack 的 PublicPath 属性，默认值为 '/'，Vue CLI 会假设你的应用是被部署在一个域名的根路径上 https://abc.com/。可以设置为子路径 - 如果你的应用被部署在 https:abc,com/sub/ 那么就设置为 '/sub'，可以设置为 CDN 路径 - 在我们的应用中，最后静态资源是要全部上传到 CDN 的，（脚手架自动完成)，所以这里可以设置为一个 cDN 域名 -'https:l/oss.imooc-Iego.com/editor'<br />
 还可以设置为绝对路径 ('' 或者 './')，这样所有的资源都会被链接为相对路径</p>
<p><strong>css.loaderOptions</strong> 属性<br />
向 CSS 相关的 loader 传递选项<br />
 Ant-design-vue 的样式变量：https:lww,antd,com docs/vue/customize-theme-cn<br />
<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Z1ZUNvbXBvbmVudC9hbnQtZGVzaWduLXZ1ZS9ibG9iL21hc3Rlci9jb21wb25lbnRzL3N0eWxlL3RoZW1lcy9kZWZhdWx0Lmxlc3M=">https://github.com/vueComponent/ant-design-vue/blob/master/components/style/themes/default.less</span><br />
 添加更多的 CSS 预处理器：<br />
<span class="exturl" data-url="aHR0cHM6Ly9jbGkudnVlanMub3JnL3poL2d1aWRlL2Nzcy5odG1sIyVFOSVBMiU4NCVFNSVBNCU4NCVFNyU5MCU4NiVFNSU5OSVBOA==">https://cli.vuejs.org/zh/guide/css.html# 预处理器</span><br />
特别注意 less 和 Iess-loader 的版本问题。不要装最新的，建议选用：</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//vue.config.js 配置：</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> isstaging <span class="token operator">=</span> <span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VUE_APP_STAGINE</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> isProduction <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token string">'production'</span></pre></td></tr><tr><td data-num="4"></td><td><pre>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token operator">/</span>生产环境要使用0SS地址</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token operator">/</span>其他环境都使用绝对路径</pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token literal-property property">publicPath</span><span class="token operator">:</span><span class="token punctuation">(</span>isProduction <span class="token number">6</span> <span class="token operator">!</span>isStaging<span class="token punctuation">)</span>'https<span class="token operator">:</span><span class="token operator">/</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">oss.imooc-lego.com</span><span class="token regex-delimiter">/</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token literal-property property">css</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    	<span class="token literal-property property">loaderOptions</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    	<span class="token literal-property property">less</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    		<span class="token literal-property property">lessoptions</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    			<span class="token literal-property property">modifyVars</span><span class="token operator">:</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>          		 <span class="token string-property property">'primary-color'</span><span class="token operator">:</span><span class="token string">'#3E7FFF'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    			<span class="token punctuation">&#125;</span>，</pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token literal-property property">javascriptEnabled</span><span class="token operator">:</span><span class="token boolean">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    		<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    	<span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token function-variable function">configureWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        config<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        	<span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>IgnorePlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>        <span class="token comment">// 打包时忽略对应的文件</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token literal-property property">resourceRegExp</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\.\/locale$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token literal-property property">contextRegExp</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">moment$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    	<span class="token keyword">if</span><span class="token punctuation">(</span>isAnalyzeMode<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    		config<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    			<span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>    <span class="token comment">// 添加打包后的文件分析工具（BundleAnalyzerPlugin）</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    				<span class="token literal-property property">analyzerMode</span> <span class="token operator">:</span> <span class="token string">'static'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    			<span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    		<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="项目构建优化"><a class="anchor" href="#项目构建优化">#</a> 项目构建优化</h1>
<p><strong>好用的 webpack 插件:webpack-bundle-analyzer</strong></p>
<p>可视化 webpack 打包后的工具包大小，便于分析依赖和进行项目优化。如上 vue.config.js 中配置。</p>
<p><strong>根据图表的优化步骤</strong></p>
<p>一、看看有没有什么重复的模块，或者没有用的模块被打包到了最终的代码中<br />
二、看看 package.json, 对比一下是否有应该在 devDeps 的模块，被错误的放置到了 deps 当中<br />
三、检查是否有重复加载的模块，或者是功能大体相同的模块。<br />
比如：使用<strong> es</strong> 版本的第三方库，享受 tree-shaking 的红利。<br />
四、检查是否有没有用的模块是否打包到了最终的文件中，通过如下插件忽略对应的文件，从而 tree-shaking 掉忽略的文件（如国际化需要的各种语言包）, 详细配置如上 vue.config.js 中。</p>
<p>webpack ignore plugin： <span class="exturl" data-url="aHR0cHM6Ly93ZWJwYWNrLmpzLm9yZ2xwbHVnaW5zL2lnbm9yZS1wbHVnaW4vI3Jvb3Q=">https://webpack.js.orglplugins/ignore-plugin/#root</span></p>
<p><strong>将三方库中全部导入更换为按需导入</strong></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span>Input<span class="token punctuation">,</span>Dropdown<span class="token punctuation">,</span>Slider<span class="token punctuation">,</span>Select<span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'Antd-vue'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> components <span class="token operator">=</span> <span class="token punctuation">[</span>Input<span class="token punctuation">,</span>Dropdown<span class="token punctuation">,</span>Slider<span class="token punctuation">,</span>Select<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">install</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    components<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>name<span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">export</span> <span class="token keyword">default</span><span class="token punctuation">&#123;</span> install <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// 在 main.js 中导入，然后 app.use</span></pre></td></tr></table></figure><p><strong>浏览器缓存优化</strong></p>
<p>一、项目即使是上线之后也会在后续追加或修改代码，如果分包较少重新上线后就不能使用浏览器缓存的文件，当分包数量较多时，就可以充分利用浏览器缓存。</p>
<p>二、分包较多时可以使用浏览器支持平行加载多个文件的特性。（HTTP1 对同一域名并行请求的个数进行了限制，HTTP2 完全突破了这个限制）</p>
<p><strong>手动分割第三方库为多个文件</strong></p>
<p>webpack 的 config.optimization 中自带一些优化的配置项：</p>
<ul>
<li>minimize：压缩</li>
<li>splitChunks：分包（可以配置 minSize 等）</li>
<li>等等</li>
</ul>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//vue.config.js 配置：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">//.... 省略</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token function-variable function">configureWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        config<span class="token punctuation">.</span>optimization<span class="token punctuation">.</span>splitChunks <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token literal-property property">maxInitialRequests</span><span class="token operator">:</span> <span class="token number">Infinity</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token literal-property property">minSize</span><span class="token operator">:</span> <span class="token number">300</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token literal-property property">cacheGroups</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                <span class="token literal-property property">antVendor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'ant-design-vue'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/](ant-design-vue)[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token literal-property property">canvasVendor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token literal-property property">name</span><span class="token operator">:</span> 'html2canvas<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/](html2canvas)[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token literal-property property">vendor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'vendor'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/](!html2canvas)(!ant-design-vue)[\\/]</span><span class="token regex-delimiter">/</span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                all <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token comment">// 匹配全部的 node_modules 中的文件</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                	<span class="token function">name</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">const</span> packageName <span class="token operator">=</span> module<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/](.*?)([\\/]|$)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">npm.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>packageName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'@'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="项目运行优化"><a class="anchor" href="#项目运行优化">#</a> 项目运行优化</h1>
<p><strong>路由懒加载</strong></p>
<p>使用 import 函数动态加载，配合魔法注释可以和 webpack 中的 bundler 相配合使用，例如：</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: "my-lodash" */</span> <span class="token string">'lodash'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">lodash</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>     <span class="token comment">// ....</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p><strong>改变 HTML 标题，增强 SEO</strong></p>
<p>项目中动态添加标题的原理：使用 HtmlWebpackPlugin 插件，插入动态 js 语句进行占位，然后通过项目中 package.json 中的 name 进行替换。</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//vue.config.js 配置：</span></pre></td></tr><tr><td data-num="2"></td><td><pre>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">//.... 省略</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token function-variable function">chainWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>       config<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>           args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">'网站标题'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>           args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>desc <span class="token operator">=</span> <span class="token string">'网站详情描述'</span></pre></td></tr><tr><td data-num="8"></td><td><pre>           <span class="token keyword">return</span> args<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>       <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>   <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 记得添加 &lt;meta name="viewport" content="&lt;%= htmlWebpackPlugin.options.desc %>"></span></pre></td></tr></table></figure><p><strong>同构渲染方式</strong><br />
服务端渲染和客户端渲染的区别就在于在哪里完成 html 完整文件的拼接：</p>
<h3 id="客户端渲染"><a class="anchor" href="#客户端渲染">#</a> 客户端渲染</h3>
<p>客户端渲染由客户端完成 html 文件的拼接，服务端只负责提供数据。</p>
<ul>
<li>优势：首屏加载快</li>
<li>劣势：不利于 SEO</li>
</ul>
<h3 id="服务端渲染"><a class="anchor" href="#服务端渲染">#</a> 服务端渲染</h3>
<p>服务端渲染由服务端完成 html 文件的凭借，客户端直接渲染即可</p>
<ul>
<li>优势：利于 SEO，</li>
<li>劣势：白屏问题（获取 html 文件较慢），服务端压力大，占用 CPU 资源。</li>
</ul>
<h3 id="同构渲染"><a class="anchor" href="#同构渲染">#</a> 同构渲染</h3>
<p>服务端先通过服务端渲染，生成 html 以及初始化数据，客户端拿到代码和初始化数据，在客户端进行激活渲染。</p>
<ul>
<li>优势：兼容了前端渲染的大部分优点（节省服务端资源、多终端适配渲染、局部刷新等），同时也具有服务端渲染首屏加载快，SEO 支持好的特点。</li>
<li>劣势：服务端必须是要 js 支持的语言，增加了整个系统的复杂度和维护成本。</li>
</ul>
<h3 id="ssg预渲染"><a class="anchor" href="#ssg预渲染">#</a> SSG 预渲染</h3>
<p><strong>静态站点生成</strong> (Static-Site Generation，缩写为 SSG)，也被称为预渲染，是另一种流行的构建快速网站的技术。</p>
<ul>
<li>
<p>如果用服务端渲染一个页面所需的数据对每个用户来说都是相同的，那就可以只渲染一次，提前在构建过程中完成，而不是每次请求进来都重新渲染页面。预渲染的页面生成后作为静态 HTML 文件被服务器托管。</p>
</li>
<li>
<p>SSG 保留了和 SSR 应用相同的性能表现：它带来了优秀的首屏加载性能。同时，它比 SSR 应用的花销更小，也更容易部署，因为它输出的是静态 HTML 和资源文件。这里的关键词是<strong>静态</strong>：SSG 仅可以用于消费静态数据的页面，即数据在构建期间就是已知的，并且在多次部署期间不会改变。每当数据变化时，都需要重新部署。</p>
</li>
<li>
<p>如果你调研 SSR 只是为了优化为数不多的营销页面的 SEO (例如 /、/about 和 /contact 等)，那么你可能需要 SSG 而不是 SSR。SSG 也非常适合构建基于内容的网站，比如文档站点或者博客。<span class="exturl" data-url="aHR0cHM6Ly9saW5rLmp1ZWppbi5jbj90YXJnZXQ9aHR0cHMlM0ElMkYlMkZ2aXRlcHJlc3MuZGV2JTJG">VitePress</span> 就是一个由 Vite 和 Vue 驱动的静态站点生成器。</p>
</li>
</ul>
<p><span class="exturl" data-url="aHR0cHM6Ly9saW5rLmp1ZWppbi5jbj90YXJnZXQ9aHR0cHMlM0ElMkYlMkZnaXRodWIuY29tJTJGdml0ZWpzJTJGdml0ZS1wbHVnaW4tdnVlJTJGYmxvYiUyRm1haW4lMkZwbGF5Z3JvdW5kJTJGc3NyLXZ1ZSUyRnByZXJlbmRlci5qcw==">Vite 脚手架渲染 SSG 代码示例</span>。</p>
<h1 id="部署与http优化"><a class="anchor" href="#部署与http优化">#</a> 部署与 HTTP 优化</h1>
<h3 id="部署"><a class="anchor" href="#部署">#</a> <strong>部署</strong></h3>
<p><strong>前端部署：https:llci,uejs,org/zh/guide/deployment.html</strong></p>
<p>原理就是：将构建生成的产物直接烤贝到任何的静态文件服务器当中。</p>
<p><strong>后端部署：https:/eggis.org/zh-cn/core/deployment.html</strong></p>
<p>几乎没有构建过程：除非你用了 typescript 等需要编译的语言。</p>
<ul>
<li>
<p>方案一：直接将本地的源代码打个压缩包拷贝到目标服务器，然后启动服务器。</p>
</li>
<li>
<p>方案二：在服务器中直接 pu 川源代码，install,. 然后启动服务器。</p>
</li>
</ul>
<h3 id="nginx反向代理"><a class="anchor" href="#nginx反向代理">#</a> <strong>Nginx: 反向代理</strong></h3>
<p><strong>Nginx</strong> 作为服务器软件，它的优点：</p>
<ul>
<li>特别适合前后端分离的项目</li>
<li>保证安全</li>
<li>非常快</li>
<li>支持负载均衡</li>
</ul>
<p>使用：</p>
<ul>
<li>安装 nginx</li>
<li>nginx    命令启动服务器</li>
<li>nginx -s stop    命令关闭服务器</li>
<li>nginx -v      命令查看配置信息</li>
<li>nginx -s reload      命令重启服务</li>
<li>配置 nginx.conf 文件</li>
</ul>
<h3 id="http缓存"><a class="anchor" href="#http缓存">#</a> <strong>HTTP 缓存</strong></h3>
<p>（若服务器使用 nginx，则在 nginx.conf 中配置）</p>
<p>Expires <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSFRUUC9IZWFkZXJzL0V4cGlyZXM=">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Expires</span><br />
<strong>Expires 响应头包含日期 / 时间，即在此时候之后，响应过期</strong><br />
使用 nginx 添加对应的响应头：expires 指令<br />
文档地址：http:l/nginx.org/en/docs/http/ngx http headers module.html</p>
<p>但是由于客户端时间和用户端时间并不总是相同的，于是有了 Cache-Control：</p>
<p><strong>Cache-Control</strong>: 通用消息头字段，被用于在 http 请求和响应中，通过指定指令来实现缓存机制。<br />
文档地址：<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXI=">https://developer</span> <span class="exturl" data-url="aHR0cDovL21vemlsbGEub3JnL3poLUNOL2RvY3MvV2ViL0hUVFAvSGVhZGVycy9DYWNoZS1Db250cm9s">mozilla.org/zh-CN/docs/Web/HTTP/Headers/Cache-Control</span></p>
<p>*<strong>Etag</strong>:ETagHTTP 响应头是资源的特定版本的标识符。这可以让缓存更高效，并节省带宽<br />
因为如果内容没有改变，Wb 服务器不需要发送完整的响应，直接返回 304 表示可以使用缓存文件。<br />
* 文档地址：<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSFRUUC9IZWFkZXJzL0VUYWc=">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/ETag</span><br />
<strong>Last-Modified</strong>: 是一个响应首部，其中包含源头服务器认定的资源做出修改的日期及时间。<br />
文档地址：<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSFRUUC9IZWFkZXJzL0xhc3QtTW9kaWZpZWQ=">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Last-Modified</span><br />
nginx Etag:<span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvbmd4X2h0dHBfY29yZV9tb2R1bGUuaHRtbCNldGFn">http://nginx.org/en/docs/http/ngx_http_core_module.html#etag</span><br />
304 Not Modified <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSElUUC9TdGF0dXMvMzA0">https://developer.mozilla.org/zh-CN/docs/Web/HITP/Status/304</span></p>
<p>浏览器使用缓存：</p>
<p><img data-src="/images/image.png" alt="/images/image.png" /></p>
<h3 id="压缩算法"><a class="anchor" href="#压缩算法">#</a> 压缩算法</h3>
<p>压缩比对照表<br />
<span class="exturl" data-url="aHR0cHM6Ly9xdWl4ZGIuZ2l0aHViLmlvL3NxdWFzaC1iZW5jaG1hcmsvI3JhdGlvLXZzLWNvbXByZXNzaW9u"> https://quixdb.github.io/squash-benchmark/#ratio-vs-compression</span></p>
<h4 id="gzip"><a class="anchor" href="#gzip">#</a> gzip</h4>
<p><strong>一、动态压缩（服务器在返回静态文件之前，由服务器对每个请求压缩后再进行输出）</strong></p>
<p>nginx 中启用 gzip：在 nginx.conf 中配置：</p>
<ul>
<li>gzip  on;        开启 gzip</li>
<li>gzip_types     text/plain  application/javascript              设置那些文件需要压缩</li>
<li>gzip_min_length   1k;         小于设置值不会压缩</li>
<li>gzip_comp_level     1;          压缩级别</li>
<li>等等</li>
</ul>
<p><strong>二、静态压缩（服务器直接使用压缩文件进行输出）</strong></p>
<p>两个步骤</p>
<ul>
<li>生成压缩文件（gzip 命令或使用 webpack 插件 compression-webpack-plugin）</li>
<li>在 ngin× 开启支持静态压缩的模块（例如 gzip_static  :  on）</li>
</ul>
<h4 id="brotli"><a class="anchor" href="#brotli">#</a> Brotli</h4>
<p><strong>一、动态压缩（服务器在返回静态文件之前，由服务器对每个请求压缩后再进行输出）</strong></p>
<p><strong>使用前提</strong><br />
浏览器支持：https:caniuse.com/brotli<br />
<strong>HTTPS 协议</strong><br />
 NGINX 对应的模块：https:/github.com/google/nginx/brotli</p>
<p>nginx 中启用 Brotli：在 nginx.conf 中配置：</p>
<ul>
<li>brotli  on;        开启 Brotli</li>
<li>brotli_types     text/plain  application/javascript              设置那些文件需要压缩</li>
<li>等等</li>
</ul>
<p><strong>二、静态压缩（服务器直接使用压缩文件进行输出，如上。）</strong></p>
<h3 id="http优化"><a class="anchor" href="#http优化">#</a> HTTP 优化</h3>
<p>HTTP 是建立在 TCP 协议之上，所以<strong> HTTP 协议的瓶颈及其优化技巧都是基于 TCP 协议本身的特性</strong>，例如 tcp 建立连接的 3 次握手和断开连接的 4 次挥手以及每次建立连接带来的延迟时间。所以减少这些重新握手和至关重要。</p>
<h4 id="keepalive属性"><a class="anchor" href="#keepalive属性">#</a> keepAlive 属性</h4>
<p>keepAlive 属性可以保持服务器端和客户端建立的会话连接，开启之后除首次建立连接外的其他请求不会进行<strong> DNS Lookup</strong>（NDS 域名解析）和<strong> Initial connection</strong>（三报文握手建立连接），可以在服务端文件中进行配置。</p>
<p><strong>KeepAlive 的优点</strong></p>
<ul>
<li>TCP 连接更少，这样就会节约 TCP 连接在建立、释放过程中，主机和路由器上的 CPU 和内存开销。</li>
<li>网络拥塞也减少了，拿到响应的延时也减少了</li>
</ul>
<h4 id="http2"><a class="anchor" href="#http2">#</a> HTTP2</h4>
<p><strong>使用 HTTP/2 提升性能</strong></p>
<ul>
<li>2010 年 SPDY <span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS9TUERZJUU2JUJDJTk0JUU1JThDJTk2JUU1JTg4JUIw">https://baike.baidu.com/item/SPDY 演化到</span></li>
<li>2015 HTTP/2 <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9HbG9zc2FyeS9IVFRQXzI=">https://developer.mozilla.org/zh-CN/docs/Glossary/HTTP_2</span></li>
</ul>
<p><strong>兼容性</strong></p>
<p>需要浏览器支持 - https:/caniuse.com/http2</p>
<p>需要 HTTPS 协议支持</p>
<p><strong>主要特性</strong></p>
<ul>
<li>二进制协议：</li>
</ul>
<p>HTTP2 由原来的文本请求（报文）转变为二进制请求帧，加快传输</p>
<ul>
<li>多路复用：</li>
</ul>
<p><strong>HTTP2 多路复用解决了浏览器同一域名并行请求数量的限制。</strong></p>
<p>在 HTTP/2 中引入了多路复用的技术。多路复用很好的解决了浏览器限制同一个域名下的请求数量的问题，同时也接更容易实现全速传输，毕竟开一个 TCP 连接都需要慢慢提升传输速度。</p>
<p><strong>同个域名只需要占用一个 TCP 连接</strong>，使用一个连接并行发送多个请求和响应，<strong>消除了因多个 TCP 连接而带来的延时和内存消耗</strong>。</p>
<ul>
<li>Header 压缩复用</li>
</ul>
<p>TTP/2 在客户端和服务器端使用 “<strong>首部表</strong>” 来跟踪和存储之前发送的键一值对，对于相同的数据，不再通过每次请求和响应发送。</p>
<p><strong>配置 HTTP2：</strong></p>
<p>依 nginx 为例：在 server 字段的 listen 字段添加：listen   443   ssl   http2;</p>
<h1 id="mongodb数据库"><a class="anchor" href="#mongodb数据库">#</a> Mongodb 数据库</h1>
<h3 id="基本操作"><a class="anchor" href="#基本操作">#</a> <strong>基本操作</strong></h3>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 导入 Mongodb 客户端构造函数</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> MongoClient<span class="token punctuation">,</span>ObjectId<span class="token punctuation">,</span> <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"mongodb"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 创建 mongo 实例 (传入 url)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 执行函数，连接 mongodb 数据库</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待实例连接</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">const</span> db <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">db</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建数据库</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">ping</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ping 命令</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'connected'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">const</span> userCollection <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建集合表</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">// 数据的插入</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">//const result = await userCollection.insertOne (&#123;name:"张三",age:18&#125;)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">//const results = await userCollection.insertMany ([&#123;name:"李四",age:12&#125;,&#123;name:"王五",age:13&#125;]);</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">//console.log (result,results); // 返回影响的信息，id 等</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">// 数据的查找</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">'张三'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">const</span> resultCursor <span class="token operator">=</span>  userCollection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//find 返回的是指针对象，不是结果</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 将游标变为数组结果</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">// console.log(results);</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">// 比较操作符 $lt 小于 $gt 大于</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">const</span> results2 <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token literal-property property">$lt</span><span class="token operator">:</span><span class="token number">16</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// console.log(results2);</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment">// 逻辑操作符 $or</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">const</span> results3 <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">$or</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token literal-property property">$gt</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"王五"</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">// console.log(results3);</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">// 元素操作符  $exists 存在与否  $type 指定类型</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">const</span> results4 <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token literal-property property">$type</span><span class="token operator">:</span><span class="token string">'number'</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">// console.log(results4);</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">//limit  第二个参数传入 options 配置（projection 表示包含字段哪些字段）</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">const</span> result5 <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token literal-property property">$type</span><span class="token operator">:</span><span class="token string">'number'</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token literal-property property">limit</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token literal-property property">skip</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token literal-property property">sort</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token literal-property property">projection</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token comment">// console.log(result5);</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment">// 更新替换数据   update 更新数据  replaceOne 替换数据，修改操作要传具体更新操作符：</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment">// 普通更新操作符： $set 设置值 $inc 增加 $rename 重命名 $unset 删除 </span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment">// 数组更新操作符： $push 数组字段添加 $pop 删除 $all 包含 $regex 正则。属性符 .$ 属性占位符</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">const</span> result6 <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">replaceOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"张三"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"Lebrown"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">const</span> result7 <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">_id</span><span class="token operator">:</span><span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span><span class="token string">'6628b9876bac632e95ead1bb'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token literal-property property">$set</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"updateOne"</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token literal-property property">$inc</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">const</span> result8 <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span><span class="token string">'6628b9876bac632e95ead1bb'</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token literal-property property">$set</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token string-property property">"hobbies.0"</span><span class="token operator">:</span><span class="token string">"golf"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">const</span> result9 <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">_id</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">ObjectId</span><span class="token punctuation">(</span><span class="token string">'6628b9876bac632e95ead1bb'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token literal-property property">hobbies</span><span class="token operator">:</span><span class="token string">'glof'</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token literal-property property">$set</span><span class="token operator">:</span><span class="token punctuation">&#123;</span><span class="token string-property property">"hobbies.$"</span><span class="token operator">:</span><span class="token string">"golf-new"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">//console.log (result8);// 返回影响信息</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment">// 删除数据：deleteOne (filter) 和 deleteMany</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="mongodb高级"><a class="anchor" href="#mongodb高级">#</a> <strong>mongodb 高级</strong></h3>
<h5 id="索引"><a class="anchor" href="#索引">#</a> 索引</h5>
<p><strong>MongoDB 索引</strong></p>
<ul>
<li>索引 (Index)<strong> 为了提高查询效率</strong></li>
<li>MongoDB 的文件类型：<strong>BSON</strong>,Binary JSON, 主要被用作 MongoDB 数据库中的数据存储和网络传输格式。</li>
<li>假如没有索引，必须扫描这个巨大 BSON 对象集合中的每个文档并选取那些符合查询条件的记录，这样是低效的。</li>
<li>索引是特殊的数据结构，索引存储在一个易于遍历读取的数据集合中。</li>
<li>为某个字段创建索引之后查找速度非常快，ObjectId 是自带的索引（ _ id _ ）。</li>
</ul>
<p><strong>创建索引</strong></p>
<p>创建索引可以直接用 Navicate 等工具，也可以代码中使用：</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//...... 省略</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 给 name 字段创建索引之前耗时很大，创建之后耗时很小</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> indexResult <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token string">"James"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">explain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>indexResult<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 创建索引，属性表示字段，值表示升序降序</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">name</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token comment">//1 表示升序</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// 取消索引</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">const</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">dropIndex</span><span class="token punctuation">(</span><span class="token string">"name_1"</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h5 id="聚合"><a class="anchor" href="#聚合">#</a> 聚合</h5>
<p>聚合操作将来自多个文档的值组合在一起，并且可以对分组数据执行各种操作以返回相应的结果。<br />
<strong>linux 常用的管道写法：</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> mongo</pre></td></tr></table></figure><p><strong>聚合常用的操作符：</strong></p>
<ul>
<li>$group 将 collection 中的 document: 分组，可用于统计结果</li>
<li>$natch 过滤数据，只输出符合结果的文档</li>
<li>$project 修改输入文档的结构（例如重命名，增加、删除字段，创建结算结果等）</li>
<li>$sot 将结果进行排序后输出</li>
<li>$imit 限制管道输出的结果个数</li>
<li>$skp 跳过制定数量的结果，并且返回剩下的结果</li>
</ul>
<p><strong>表达式操作符：</strong></p>
<ul>
<li>sum计算总和，{sum:1} 表示返回总和 ×1 的值（即总和的数量），使用 {<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi><msup><mo>:</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">sum:&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel">:</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> 制定字段 '} 也能直接获取制定字段的值的总和</li>
<li>$avg 求平均值</li>
<li>$min 求 min 值</li>
<li>$max 求 max 值</li>
<li>$push 将结果文档中插入值到一个数组中</li>
<li>$frst 根据文档的排序获取第一个文档数据</li>
<li>$last 同理，获取最后一个数据</li>
</ul>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//.....</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> pipeLine <span class="token operator">=</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">&#123;</span> <span class="token literal-property property">$match</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">age</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">$gt</span> <span class="token operator">:</span> <span class="token number">30</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#123;</span> <span class="token literal-property property">$group</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">_id</span> <span class="token operator">:</span> <span class="token string">"$steam"</span> <span class="token punctuation">,</span> <span class="token literal-property property">total</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">$sum</span> <span class="token operator">:</span> <span class="token string">"$age"</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">,</span> <span class="token literal-property property">count</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">$sum</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#123;</span> <span class="token literal-property property">$sort</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">total</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>cosnt result <span class="token operator">=</span> <span class="token keyword">await</span> userCollection<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>pipeLine<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">//....</span></pre></td></tr></table></figure><h5 id="多表联查"><a class="anchor" href="#多表联查">#</a> 多表联查</h5>
<p><strong>普通方式使用多表联查需要两次查询</strong></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 导入 Mongodb 客户端构造函数</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> MongoClient<span class="token punctuation">,</span>ObjectId<span class="token punctuation">,</span> <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"mongodb"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 创建 mongo 实例 (传入 url)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// 执行函数，连接 mongodb 数据库</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待实例连接</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">const</span> db <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">db</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建数据库</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">ping</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ping 命令</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'connected'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 获取表</span></pre></td></tr><tr><td data-num="13"></td><td><pre>     <span class="token keyword">const</span> teamCollection <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'team'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     <span class="token keyword">const</span> playerCollection <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">'player'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>     <span class="token keyword">const</span> netsTeam <span class="token operator">=</span> <span class="token keyword">await</span> teamCollection<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">team</span><span class="token operator">:</span><span class="token string">"NETS"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     <span class="token keyword">const</span> netsPlayers <span class="token operator">=</span> <span class="token keyword">await</span> playerCollection<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token literal-property property">team</span><span class="token operator">:</span>netsTeam<span class="token punctuation">.</span>_id<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p><strong>使用聚合中 $lookup 进行多表联查只需要一次查询：</strong></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//...</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> pipeLine2 <span class="token operator">=</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token literal-property property">$match</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">team</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">$exists</span> <span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token literal-property property">$lookup</span> <span class="token operator">:</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token literal-property property">from</span> <span class="token operator">:</span> <span class="token string">"team"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token literal-property property">localField</span> <span class="token operator">:</span> <span class="token string">"team"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token literal-property property">foreignField</span> <span class="token operator">:</span> <span class="token string">"_id"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">as</span> <span class="token operator">:</span> <span class="token string">"team"</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">]</span> </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">const</span> playerWithTeam <span class="token operator">=</span> <span class="token keyword">await</span> playerCollection<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span>pipeLine2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>playerWithTeam<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">//...</span></pre></td></tr></table></figure><h3 id="数据库设计"><a class="anchor" href="#数据库设计">#</a> 数据库设计</h3>
<p>[MongoDB 最佳设计实践](<span class="exturl" data-url="aHR0cHM6Ly93d3cubW9uZ29kYi5jb20vZGV2ZWxvcGVyL2FydGljbGUvbW9uZ29kYi0=">https://www.mongodb.com/developer/article/mongodb-</span><br />
schema-design-best-practices/)</p>
<p>关键问题：数据产生关系的时候，选择内嵌还是引用？</p>
<p><strong>内嵌模式：</strong></p>
<p>优势：</p>
<ul>
<li>只需要一次查询就可以查询所有的信息。</li>
<li>避免多集合查询。</li>
<li>只需要一个操作就可以更新多个信息。</li>
</ul>
<p>劣势：</p>
<ul>
<li>单个文档太大，查询可能更耗时，获得的无关信息概率增大。</li>
<li>针对每个文档，MongoDB 有一个 16M 的最大限制，内嵌太多，可能超过这个限制。</li>
</ul>
<p><strong>引用模式：</strong></p>
<p>优势：</p>
<ul>
<li>将数据分散到不同文档，数据量会变小。</li>
<li>不太会超过 16M 最大限制。</li>
<li>每次查询取得不必要数据的慨率降低。</li>
</ul>
<p>劣势：需要多次查询才能获得最终数据</p>
<p><strong>最佳设计实践：</strong></p>
<ul>
<li>
<p>一对几个：推荐使用内嵌形式</p>
</li>
<li>
<p>一对很多：推荐使用引用形式</p>
<ul>
<li>子集合中使用一个字段保存父集合的_id   ； 或者：</li>
<li>父集合中使用一个数组保存子集合的_id</li>
</ul>
</li>
<li>
<p>一对亿万：只能子集合中使用一个字段保存父集合的_id</p>
</li>
</ul>
<h3 id="访问权限管理"><a class="anchor" href="#访问权限管理">#</a> <strong>访问权限管理</strong></h3>
<p><strong>授权文档</strong>：<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1vbmdvZGIuY29tL21hbnVhbC9jb3JlL2F1dGhlbnRpY2F0aW9uLw==">https://docs.mongodb.com/manual/core/authentication/</span><br />
<strong> 内置的 Roles</strong>：<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1vbmdvZGIuY29tL21hbnVhbC9yZWZlcmVuY2UvYnVpbHQtaW4tcm9sZXMv">https://docs.mongodb.com/manual/reference/built-in-roles/</span></p>
<p><strong>在 mongo 命令行中输入：</strong></p>
<pre><code class="language-cmd">show dbs
use admin
# mongodb基于RBAC进行权限管理，设置roles可以设置相应的全选，见上。
db.createUser(&#123; user : 'root' , pwd : '123456' , roles : ['root'] &#125;) 
db.auth('root','123456')
# --auth 开启数据库的权限验证，也可以直接在mongo.conf中配置（先终止运行mongod）
mongod --config /usr/local/etc/mongo.conf --auth
# 操作配置了权限管理的数据库
mongo -u &quot;root&quot; -p &quot;123456&quot; --authenticationDatabase &quot;admin&quot;
</code></pre>
<p><strong>初始化一个新数据库以后期望的步骤</strong></p>
<ul>
<li>创建 admin 级谜别的 root 用户 /roles:root</li>
<li>创建对应的数据库 lego</li>
<li>创建该数据库的管理员 dmq/roles:readWrite</li>
<li>代码中，使用管理员 dmq 的用户名密码链接数据库并且完成操作。</li>
</ul>
<p>步骤如下：</p>
<pre><code class="language-cmd">show dbs
use lego
db.createUser(&#123; user : &quot;dmq&quot; , pwd : '123456' , roles : [&#123; role : &quot;readWrite&quot; , db : &quot;lego&quot; &#125;]&#125;)
# 重启服务：mongod --config /usr/local/etc/mongo.conf --auth
# 这样在mongodb的配置文件中设置用户信息，就保证只能读取数据库信息，保证了数据库的安全。（如果用户信息来自admin数据库就需要配置authSource:'admin'。）
</code></pre>
<h1 id="mongoose"><a class="anchor" href="#mongoose">#</a> Mongoose</h1>
<p><strong>出现的原因：</strong></p>
<p>使用原生的 mongoDB nodejs driver 数据结构及其操作过于灵活。</p>
<p><strong>mongoose：MongoDB 的 ODM 文档对象映射</strong>（mongoose 之于 mongodb 类似于 ts 之于 js，都是在原有的基础之上加一层抽象层，进行类型定义等操作）</p>
<p>mongoose：<span class="exturl" data-url="aHR0cHM6Ly9tb25nb29zZWlzLmNvbS8=">https://mongooseis.com/</span></p>
<ul>
<li>建立在 native mongoDB nodejs driver 之上</li>
<li>提出 Modl, 数据模型的概念，用来约束集合中的数据结构</li>
<li>非常多扩展的内容</li>
<li>它是一个 ODM (Object Document Mapping) 工具。</li>
</ul>
<h3 id="orm"><a class="anchor" href="#orm">#</a> ORM</h3>
<p>ORM 指的是<strong> Object Relational Mapping 对象关系映射</strong>，针对于<strong>关系型数据库</strong>。</p>
<p><strong>简单说，ORM 就是通过实例对象的语法，完成关系型数据库的操作的技术。</strong></p>
<p><strong>ORM 优点</strong></p>
<ul>
<li>不需要再去写晦涩的 SQL 语句。</li>
<li>使用面向对象的方式操作数据，代码量少，语义性好，容易理解。</li>
<li>Classes 类 - Tables</li>
<li>Objects 实例 - Records (表中的一行数据)</li>
<li>Attributes 属性 - Records</li>
<li>内置很多功能，数据验证，清洗，预处理等等操作。</li>
</ul>
<h3 id="odm"><a class="anchor" href="#odm">#</a> ODM</h3>
<p>ODM 指的是<strong> Object Document Mapping 对象文档映射</strong>。ODM 针对于<strong> noSql 数据库</strong>，关注文档模型，mongoose 是 ODM 的一种实现，可以用于约束数据类型。</p>
<figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> User <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">"User"</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token literal-property property">username</span><span class="token operator">:</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span> <span class="token operator">:</span> string <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token literal-property property">password</span><span class="token operator">:</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span> <span class="token operator">:</span> String <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">//user object</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">const</span> newUser <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token literal-property property">username</span><span class="token operator">:</span><span class="token string">"john-doe"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token literal-property property">password</span><span class="token operator">:</span><span class="token string">"helloworld"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">await</span> newUser<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="egg-mongoose"><a class="anchor" href="#egg-mongoose">#</a> egg-mongoose</h1>
<p>官网文档很好，请自行查看。</p>
<h1 id="stream"><a class="anchor" href="#stream">#</a> Stream</h1>
<h3 id="介绍"><a class="anchor" href="#介绍">#</a> 介绍</h3>
<p>Stream 的官方文档：<span class="exturl" data-url="aHR0cHM6Ly9ub2RlanMub3JnL2FwaS9zdHJlYW0uaHRtbA==">https://nodejs.org/api/stream.html</span><br />
<strong> 流是 Node.js 中最好，也是最容易误解的慨念</strong><br />
流就是数据的合集，数据可以是字符串也可以是数组，流的数据不是一次性全部获得的。</p>
<p>大文件输出方式：</p>
<ul>
<li>
<p>直接读取</p>
<p>输入的文件 ------------ 读取到内存 ---------------- 输出文件内容</p>
</li>
<li>
<p>流式读取</p>
<p>输入的文件 ------------ 通过可读流读取到管道 ----------------- 通过可写流输出文件内容</p>
</li>
</ul>
<p><strong>Node.js 支持流的内置模块：</strong></p>
<p><strong>Readable Streams:</strong></p>
<ul>
<li>HTTP responses,on the client</li>
<li>HTTP requests,on the server</li>
<li>fs read streams</li>
<li>zlib streams</li>
<li>crypto streams</li>
<li>TCP sockets</li>
<li>child process stdout and stderr</li>
<li>process.stdin</li>
</ul>
<p><strong>Writable  Streams:</strong></p>
<ul>
<li>HTTP requests,on the client</li>
<li>HTTP responses,on the server</li>
<li>fs write streams</li>
<li>zlib streams</li>
<li>crypto streams</li>
<li>TCP sockets</li>
<li>child process stdin</li>
<li>process.stdout,process.stderr</li>
</ul>
<p><strong>流的类型：</strong></p>
<ul>
<li>Readable - 可读操作。</li>
<li>Vritable - 可写操作。</li>
<li>Duplex - 可读可写操作.</li>
<li>Transform - 操作被写入数据，然后读出结果。</li>
</ul>
<h3 id="pipe"><a class="anchor" href="#pipe">#</a> pipe</h3>
<p><strong>流的流动：</strong></p>
<p>可读流 Readable（数据源 input）----------------------pipe 管道 ---------------------------------------- 可写流 Writable（输出 output）</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createReadStream<span class="token punctuation">,</span> createWriteStream <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> readStream <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'./a.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>readStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>可读流 Readable（数据源 input）-------------pipe 管道 --------------- 转换流 Transform----------------pipe 管道 ----------- 可写流 Writable（输出 output）</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createReadStream<span class="token punctuation">,</span> createWriteStream<span class="token punctuation">,</span> write <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> readStream <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'./a.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> writeStream <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'./b.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>readStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writeStream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h3 id="原理-3"><a class="anchor" href="#原理-3">#</a> 原理</h3>
<p><strong>流是基于 EventEmitter（事件），pipe 方法是基于事件封装的的语法糖，常见的事件有：</strong></p>
<p><strong>Readable  Streams：可读流事件和函数</strong></p>
<ul>
<li>Events
<ul>
<li>data-- 当没有数据时触发</li>
<li>end-- 没有更多的数据可读时触发</li>
<li>error-- 在接受和写入过程中发生错误时触发</li>
<li>finish-- 所有数据已被写入到底层系统时触发</li>
<li>close</li>
<li>readable</li>
</ul>
</li>
<li>Functions
<ul>
<li>pipe() , unpipe()</li>
<li>read() , unshift() , resume()</li>
<li>pause() , isPaused()</li>
<li>setEncoding()</li>
</ul>
</li>
</ul>
<p><strong>Writable  Streams：写入流事件和函数</strong></p>
<ul>
<li>Events
<ul>
<li>drain</li>
<li>finish</li>
<li>error</li>
<li>close</li>
<li>pipe/unpipe</li>
</ul>
</li>
<li>Functions
<ul>
<li>write()</li>
<li>end()</li>
<li>cork() , uncork()</li>
<li>setDefaultEncoding()</li>
</ul>
</li>
</ul>
<p><strong>pipe 方法原理：</strong></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createReadStream <span class="token punctuation">,</span> createWriteStream <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> readStream <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'./a.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> writeStream <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'./b.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>readStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span> <span class="token punctuation">,</span> <span class="token parameter">chunk</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    writeStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>readStream<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    writeStream<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>压缩：</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createReadStream <span class="token punctuation">,</span> createWriteStream <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createGzip <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'zlib'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> readStream <span class="token operator">=</span> <span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'./a.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">const</span> writeStream <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'./b.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>readStream<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span><span class="token function">createGzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writeStream<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>封装：</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre>cosnt savePromise <span class="token operator">=</span> <span class="token punctuation">(</span>readStream <span class="token punctuation">,</span> writeStream <span class="token operator">=</span> stdout<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        readStream</pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writeStream<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span>resolve<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        	<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span>reject<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="pipeline"><a class="anchor" href="#pipeline">#</a> pipeline</h3>
<p><strong>使用 pipe 方法有时会存在一个问题：</strong></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//....</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'./a.txt'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>stdout<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span>finishFn<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span>errFn<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 这里监听的是 pipe 后的错误，对于 createReadStream 的错误则会卡死</span></pre></td></tr></table></figure><p><strong>于是推出了 pipeline 方法：</strong></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//...</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">pipeLine</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'./a.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>zlib<span class="token punctuation">.</span><span class="token function">createGzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'./b.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'pipeline failed'</span><span class="token punctuation">,</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'successed'</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="对象存储服务"><a class="anchor" href="#对象存储服务">#</a> 对象存储服务</h1>
<p><strong>自己完成静态文件存储的问题</strong></p>
<ul>
<li>Nod.js 不擅长处理静态文件的存储和展示，没有未静态文件做特殊的优化</li>
<li>如果将图片生成多种处理格式要耗费大量的资源和空间</li>
</ul>
<p><strong>各三方比对</strong></p>
<h3 id="阿里云oss"><a class="anchor" href="#阿里云oss">#</a> <span class="exturl" data-url="aHR0cHM6Ly93d3cuYWxpeXVuLmNvbS9wcm9kdWN0Li9vc3M=">阿里云 OSS</span></h3>
<p><strong>特点</strong></p>
<ul>
<li>支持丰富的图片处理 https://help.aliyun.com/document._detail/44686.html</li>
<li>egg.js 有对应的插件：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VnZ2pzL2VnZy1vc3M=">https://github.com/eggjs/egg-oss</span></li>
</ul>
<p><strong>价格</strong></p>
<ul>
<li>下行流量 100GB 一年 352 元 https://common-buy.aliyun.com/?spm=5176.7933691.J_5253785160.1.2e394c59q3FIsA&amp;commodityCode=ossbag#/buy</li>
<li>基本图片处理：每月 0-10TB: 免费 &gt; 10TB:0.025 元 / GB</li>
</ul>
<h3 id="七牛云kodo"><a class="anchor" href="#七牛云kodo">#</a> <span class="exturl" data-url="aHR0cHM6Ly93d3cucWluaXUuY29tL3ByaWNlcy9rb2Rv">七牛云 KODO</span></h3>
<p><strong>特点：</strong></p>
<ul>
<li>多媒体处理功能非常丰富 https://www.giniu.com/products/dora</li>
<li>图片视频处理</li>
<li>审核</li>
<li>人工智能分析</li>
</ul>
<p><strong>价格：</strong></p>
<ul>
<li>外网流出 100GB - 年 278.4 元 https://qmall.qiniu.com/template./MTEy?spec_combo=MzE0NQ</li>
<li>基本图片处理：每月 0-20TB: 免费 20TB 以上：0.025 元 / GB https:/www.qiniu.com/prices/dora</li>
</ul>
<h3 id="腾讯云cos"><a class="anchor" href="#腾讯云cos">#</a> <span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kb2N1bWVudC9wcm9kdWN0LzQzNg==">腾讯云 COS</span></h3>
<p><strong>特点：</strong></p>
<p>图像处理有一些新的亮点，比如自研的 TPG 压缩等</p>
<p><strong>价格：</strong></p>
<ul>
<li>外网流出 100GB 一年 396 元 https://buy.cloud.tencent..com/price/cos#tab0-list1</li>
<li>基本图片处理：每月 0-20TB: 免费 20TB 以上：0.025 元 / GB</li>
<li><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kb2N1bWVudC9wcm9kdWN0LzEyNDYvNDUyNzQ=">https://cloud.tencent.com/document/product/1246/45274</span></li>
<li>图片压缩：1 元 / 千次</li>
</ul>
<h1 id="ssr服务端渲染"><a class="anchor" href="#ssr服务端渲染">#</a> SSR 服务端渲染</h1>
<h3 id="介绍-2"><a class="anchor" href="#介绍-2">#</a> 介绍</h3>
<p><strong>SSR-Server Side Rendering</strong></p>
<p>Vue 关于 SSR 的介绍：<span class="exturl" data-url="aHR0cHM6Ly9zU3IudWVqcy5vcmcvemg=">https://sSr.uejs.org/zh</span></p>
<p><strong>SSR 的优点</strong></p>
<ul>
<li>更好的 SEO</li>
<li>更快的渲染时间 (Time to content)，</li>
</ul>
<p><strong>SSR 的缺点</strong></p>
<ul>
<li>
<p>开发的限制，浏览器相关的操作只能在特定的钩子函数中使用</p>
</li>
<li>
<p>SPA 应用完全静态化，而 SSR app 需要 Node.js Server 才能运行</p>
</li>
<li>
<p>服务端负荷更高</p>
</li>
</ul>
<p><strong>SSR 的实现：</strong></p>
<ul>
<li>
<p>基本原理：@vue/server-renderer <span class="exturl" data-url="aHR0cHM6Ly92My51ZWpzLm9yZy9ndWlkZS9zc3IvZ2V0dGluZy1zdGFydGVkLmh0bWwjaW5zdGFsbGF0aW9u">https://v3.uejs.org/guide/ssr/getting-started.html#installation</span></p>
</li>
<li>
<p>使用 createSSRApp，renderToString 以及 renderToStream 方法</p>
</li>
</ul>
<p><strong>成熟的，大而全的 SSR 通用开发框架：</strong></p>
<ul>
<li>Nuxt.js <span class="exturl" data-url="aHR0cHM6Ly9udXh0anMub3JnLw==">https://nuxtjs.org/</span>  （Vue）</li>
<li>React 类似的 Next.js <span class="exturl" data-url="aHR0cHM6Ly9uZXh0anMub3Jn">https://nextjs.org</span> （React）</li>
</ul>
<h3 id="ssr"><a class="anchor" href="#ssr">#</a> SSR</h3>
<p>express 等框架的 res.render 方法可以渲染 html 模板，使用的是 nunjucks 库进行数据填充。</p>
<p>index.html</p>
<figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>no-js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>description<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>  //根据传入的props动态添加style样式</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment"></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>index.js  (依据 express 框架为例：)</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//...res 是响应参数</span></pre></td></tr><tr><td data-num="2"></td><td><pre>res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>html</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h3 id="vue中ssr"><a class="anchor" href="#vue中ssr">#</a> vue 中 SSR</h3>
<p>1、vue3 有包：@vue/server-renderer，在 3.2.13 版本以上内置了，低于此版本需要自行安装。</p>
<p>2、使用：</p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//.......... res 是服务端返回</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> pipeline <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'stream/promises'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> createSSRApp <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> renderToString <span class="token punctuation">,</span> renderToNodeStream <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@vue/server-renderer'</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">const</span> vueApp <span class="token operator">=</span> <span class="token function">createSSRApp</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function-variable function">data</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span> <span class="token literal-property property">msg</span><span class="token operator">:</span><span class="token string">'hello world'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">'&lt;h1>&lt;/h1>'</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">const</span> appContent <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">renderToString</span><span class="token punctuation">(</span>vueApp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>res<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/html'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>res<span class="token punctuation">.</span>body <span class="token operator">=</span> appContent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment">// 或者使用流式输出：</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token function">renderToNodeStream</span><span class="token punctuation">(</span>vueApp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>res<span class="token punctuation">.</span>statys <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">await</span> <span class="token function">pipeline</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h1 id="rbac权限验证"><a class="anchor" href="#rbac权限验证">#</a> RBAC 权限验证</h1>
<h3 id="介绍-3"><a class="anchor" href="#介绍-3">#</a> 介绍</h3>
<p><strong>权限验证的场景以及需求：</strong></p>
<ul>
<li>特定的角色的用户才能操作特定的资源</li>
<li>不同的用户能操作同类资源的特定实体</li>
<li>不同的用户操作特定资源的不同属性</li>
</ul>
<p><strong>谁 (User) 拥有什么权限 (Authority）去操作 (Operation) 哪些资源 (Resource)</strong><br />
 根据角色完成权限的控制 - RBAC (role based access control)，其实就是在原本用户 ------- 权限的对应关系之上加一层中间层角色：用户 ------ 角色 ----- 权限。好处是<strong>使得用户和权限的对应关系更加清晰和易于掌控</strong>。</p>
<h3 id="使用"><a class="anchor" href="#使用">#</a> 使用</h3>
<p>Node.js 实现 RBAC 的库：</p>
<ul>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29udXJ5L2FjY2Vzc2NvbnRyb2w=">AccessControl.js（不推荐，不维护了）</span></p>
<ul>
<li>1.6k Star</li>
<li>3 年没有更新，很多 issue 没人处理</li>
<li>不支持 ts</li>
</ul>
</li>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nhc2Jpbi9ub2RlLWNhc2Jpbg==">Casbin</span></p>
<ul>
<li>1.7k Star</li>
<li>ts 编写，支持多种编程语言</li>
<li>概念比较复杂，使用略繁琐</li>
</ul>
</li>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3N0YWxuaXkvY2FzbA==">Casl</span></p>
<ul>
<li>
<p>3.4k Star</p>
</li>
<li>
<p>ts 编写</p>
</li>
<li>
<p>简单易用，可读性良好</p>
</li>
</ul>
</li>
</ul>
<h3 id="casl使用"><a class="anchor" href="#casl使用">#</a> <strong>Casl 使用</strong></h3>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> AbilityBuilder <span class="token punctuation">,</span> Ability <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'@casl/ability'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Work</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">attrs</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>attrs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">const</span> templateWork <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Work</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">id</span> <span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">,</span> <span class="token literal-property property">isTemplate</span> <span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">const</span> notWork <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Work</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">id</span> <span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">,</span> <span class="token literal-property property">isTemplate</span> <span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">function</span> <span class="token function">defineRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> can <span class="token punctuation">,</span> cannot <span class="token punctuation">,</span>build <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbilityBuilder</span><span class="token punctuation">(</span>Ability<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token function">can</span><span class="token punctuation">(</span><span class="token string">'read'</span><span class="token punctuation">,</span><span class="token string">'Work'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token function">cannot</span><span class="token punctuation">(</span><span class="token string">'delete'</span><span class="token punctuation">,</span><span class="token string">'Work'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token function">can</span><span class="token punctuation">(</span><span class="token string">'update'</span><span class="token punctuation">,</span><span class="token string">'Work'</span><span class="token punctuation">,</span><span class="token punctuation">&#123;</span><span class="token literal-property property">isTemplate</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>templateWork<span class="token punctuation">.</span>constructor<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">const</span> rules <span class="token function">defineRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rules<span class="token punctuation">.</span><span class="token function">can</span><span class="token punctuation">(</span><span class="token string">'read'</span><span class="token punctuation">,</span><span class="token string">'Work'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rules<span class="token punctuation">.</span><span class="token function">can</span><span class="token punctuation">(</span><span class="token string">'delete'</span><span class="token punctuation">,</span><span class="token string">'Work'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rules<span class="token punctuation">.</span><span class="token function">can</span><span class="token punctuation">(</span><span class="token string">'update'</span><span class="token punctuation">,</span>templateWork<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rules<span class="token punctuation">.</span><span class="token function">can</span><span class="token punctuation">(</span><span class="token string">'update'</span><span class="token punctuation">,</span>notWork<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="部署-2"><a class="anchor" href="#部署-2">#</a> 部署</h1>
<h3 id="传统模式"><a class="anchor" href="#传统模式">#</a> 传统模式</h3>
<p><strong>本地开发</strong><br />
使用<span class="exturl" data-url="aHR0cHM6Z2l0aHViLmNvbS9lZ2dqcy9lZ2ctYmlu"> egg-bin</span>，提供了便捷的方式在本地进行开发、调试、单元测试，它可以自动的监控文件的修改，然后重新运行对应的命令。<br />
采用的配置文件是：config.default.ts<br />
 启动开发环境命令为 <code>egg-bin dev</code> <br />
<strong> 生产环境运行程序</strong><br />
<span class="exturl" data-url="aHR0cHM6Ly9wbTIua2V5bWV0cmljcy5pby8="> pm2-process manager</span></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">node</span> script.js </pre></td></tr><tr><td data-num="2"></td><td><pre>pm2 start script.js</pre></td></tr></table></figure><p><strong>PM2 的优势：</strong></p>
<ul>
<li>cluster（集群）模式运行</li>
<li>自动重启 auto reload</li>
<li>热替换 hot reload</li>
<li>性能监控 Monitoring</li>
</ul>
<p><strong>egg.js 中有对应于 PM2 的内置方法：</strong></p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VnZ2pzL2VnZy1zY3JpcHRz">egg-scripts</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2VnZ2pzL2VnZy1jbHVzdGVy">egg-cluster</span></li>
</ul>
<p><strong>egg.js 生产环境启动和关闭</strong></p>
<pre><code class="language-cmd">egg-scripts start
egg-scripts stop
</code></pre>
<p><strong>配置文件</strong><br />
 config.prod.ts 和 config.default.ts<br />
<strong> 编译过程</strong><br />
需要手动将 ts 转换为 js, 借助<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3doeGF4ZXMvZWdnLXRzLWhlbHBlcg=="> ets</span><br />
 <code>特别注意将项目中的typscript版本升级到4.4.3 </code></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">npm</span> run tsc</pre></td></tr></table></figure><h3 id="cluster模型"><a class="anchor" href="#cluster模型">#</a> Cluster 模型</h3>
<p><strong>Egg.js Cluster 模型的原理</strong><br />
 Egg.js 关于这部分内容的文档：<span class="exturl" data-url="aHR0cHM6Ly9lZ2dqcy5vcmcvemgtY24vY29yZS9jbHVzdGVyLWFuZC1pcGMuaHRtbA==">https://eggjs.org/zh-cn/core/cluster-and-ipc.html</span><br />
<strong> 为什么要采用 Cluster 模式</strong><br />
 JavaScript 代码是运行在单线程上的，那么如果用 Node.js 来做 Web Server, 就无法享受到多核运算的好处。<br />
<strong>什么是 Cluster 模式</strong><br />
文档：<span class="exturl" data-url="aHR0cDovL25vZGVqcy5jbi9hcGkvY2x1c3Rlci5odG1s">http://nodejs.cn/api/cluster.html</span></p>
<p>Node.js 的单个实例在单个线程中运行。为了利用多核系统，用户有时会想<br />
要启动 Node.js 进程的集群来处理负载。</p>
<ul>
<li>在服务器上同时启动多个进程</li>
<li>每个进程里都跑的是同一份源代码（将一个进程的工作分给多个进程去做）</li>
<li>这些进程可以同时监听一个端口</li>
</ul>
<p><strong>Cluster 的运行模式：</strong></p>
<p>Request-------------master_process 主进程 ---------------------workers 进程（多个）</p>
<p><strong>进程间通信（IPC）：</strong></p>
<p><span class="exturl" data-url="aHR0cHM6Ly96aC53aWtpcGVkaWEub3JnL3dpa2kvJUU4JUExJThDJUU3JUE4JThCJUU5JTk2JTkzJUU5JTgwJTlBJUU4JUE4JThB">IPC Inter-Process Communication</span></p>
<p>IPC 指的是至少两个进程或线程间传送数据或信号的一些技术或者方法，Node.js 将其封装为基于事件的形式便于使用。</p>
<p><strong>Cluster 使用：</strong></p>
<figure class="highlight js"><figcaption data-lang="JavaScript"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> http <span class="token keyword">from</span> <span class="token string">'http'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> cluster <span class="token keyword">from</span> <span class="token string">'cluster'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> cpus <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'os'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> process <span class="token keyword">from</span> <span class="token string">'process'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">if</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>isPrimary<span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token comment">// 通过 cluster.isPrimary 来分支处理主进程和 worker 进程</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">master </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> running</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">const</span> cpuLength <span class="token operator">=</span> <span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cpuLength <span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        cluster<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    cluster<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">worker</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">worker </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>worker<span class="token punctuation">.</span>process<span class="token punctuation">.</span>pid<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> exited</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span> <span class="token comment">// 分支判断到是 worker 进程，cluster.fork () 复制的 worker 进程都会进入</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">worker </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span> process<span class="token punctuation">.</span>pid <span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> started</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span>workers<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获得子进程，可以通过 process.send 和 on ('message') 事件进行进程间通信。</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>egg.js 中对于 Cluster 的二次封装：</strong></p>
<ul>
<li>使用 egg-scripts 启动 master process</li>
<li>使用 egg-cluster 启动和 CPU 核数相等的 app_worker process</li>
<li>使用 egg-cluster 启动的一个独特的 agent_worker process</li>
</ul>
<p><strong>进程守护</strong><br />
考虑到生产环境的健壮性，必须保证进程异常的情况下怎样处理。<br />
<strong>当代码抛出异常并没有被捕获的时候，worker 使用 process.on ('uncaughtException',handler) 来捕获对应的错误，这时进程处于不确定的状态，需要优雅退出。</strong></p>
<p><strong>系统异常</strong><br />
而当一个进程出现异常导致 crash 或者被系统杀死时，不像未捕获异常发生时我们还有机会让进程继续执行，Master 立刻 fork 一个新的 Worker。<br />
<strong>Agent 机制</strong><br />
有一些特殊性质的工作，不能多个 worker 一起合作，容易造成混乱。对于这种工作 egg.js 提供了一个新的 agent 进程来完成。</p>
<p><strong>Egg.js 三种进程的总结：</strong></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>进程数量</th>
<th>作用</th>
<th>稳定性</th>
<th>是否运行业务代码</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master 进程</td>
<td>1</td>
<td>进程管理，进程间消息转发</td>
<td>非常高</td>
<td>否</td>
</tr>
<tr>
<td>Agent 进程</td>
<td>1</td>
<td>后台运行工作</td>
<td>高</td>
<td>少量</td>
</tr>
<tr>
<td>Workers 进程</td>
<td>CPU 核数</td>
<td>执行业务代码</td>
<td>一般</td>
<td>是</td>
</tr>
</tbody>
</table>
<p><strong>Cluster 模型和 Node 多进程的区别：</strong></p>
<ul>
<li>Cluster 模块可以将一个 node 进程分裂成多个子进程，每个子进程独立运行在 cpu 内核上，以提升应用程序的并发能力和性能，通过主进程和子进程之间的通信来实现负载均衡，处理并发请求。</li>
<li>node 多进程使用 child_process 模块，其不具备负载均衡和通信机制，需要自行实现进程间通信和负载均衡逻辑。可用于处理长时操作，返回结果给主进程。</li>
</ul>
<p><strong>Node.js 压力测试工具：</strong></p>
<p>模拟高并发场景：<span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvbG9hZHRlc3Q=">Loadtest</span></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># n                   总过发送多少个请求</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># c concurrency       同时有几个客户端在发送请求</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># rps request per seconds   每秒发送多少个请求</span></pre></td></tr><tr><td data-num="4"></td><td><pre>loadtest <span class="token parameter variable">-n</span> <span class="token number">400</span> <span class="token parameter variable">-c</span> <span class="token number">10</span> <span class="token parameter variable">--rps</span> <span class="token number">200</span> http://mysite.com/</pre></td></tr></table></figure><h1 id="云服务器"><a class="anchor" href="#云服务器">#</a> 云服务器</h1>
<h4 id="购买"><a class="anchor" href="#购买">#</a> 购买</h4>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYWxpeXVuLmNvbS9wcm9kdWN0L2Vjcw==">阿里云 ECS</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9wcm9kdWN0L2N2bQ==">腾讯云 CVM</span></p>
<p>价格（学生优惠）：<span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9hY3QvY2FtcHVzP2Zyb209MTQ1OTk=">https://cloud.tencent.com/act/campus?from=14599</span> 12G 38</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuaHVhd2VpY2xvdWQuY29tL3Byb2R1Y3QvZWNzLmh0bWw=">华为云 ECS</span></p>
<h4 id="登录"><a class="anchor" href="#登录">#</a> 登录</h4>
<p><strong>为什么使用 root 登录时一个不好的实践</strong></p>
<ul>
<li>有非常多的 bot 会尝试使用 root+pwd 的 ssh 方式暴力登录机器，当尝试成功以后，黑客就会控制整个系统。</li>
<li>假如使用特定用户名 + pwd,bot 需要先猜测用户名 (N 次)，然后是密码 (M 次)，这样复杂度提升到 N*M</li>
<li>root 可以造成更大的危害，影响整个系统，而某个特定用户只能影响它的文件系统</li>
</ul>
<p><strong>创建一个用户账号进行登录</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 远程登录</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">ssh</span> root@xxx.xx.xx.xx</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 添加用户以及设置密码</span></pre></td></tr><tr><td data-num="4"></td><td><pre>adduser dmq</pre></td></tr></table></figure><p><strong>设置该用户拥有 sudo 权限，给予它在登录以后切换到 root 的能力</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 修改权限，u 表示所有者，w 表示写权限 + 表示添加</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">chmod</span> u+w /etc/sudoers</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 编辑文件</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">vim</span> /etc/sudoers</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 找到  `root ALL=(ALL)  ALL`</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 再加一行  `dmq ALL=(ALL)  ALL`</span></pre></td></tr></table></figure><p><strong>使用新用户登录并且测试权限</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">ssh</span> dmq@xxx.xx.xx.xx</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 可以使用 su 直接切换为 root 用户</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 也可以使用 sudo 快捷的使用 root 权限进行操作</span></pre></td></tr></table></figure><p><strong>禁止使用 root 远程登录 ssh</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 修改 ssh 配置</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">vim</span> /etc/ssh/sshd_config I</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 修改 yes 为 no</span></pre></td></tr><tr><td data-num="4"></td><td><pre>PermitRootLogin no</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 重启 sshd 服务</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">service</span> sshd restart</pre></td></tr></table></figure><p><strong>可选：不使用密码登录</strong><br />
为什么使用密码登录有时候是一个不好的实践？<br />
<strong>非常简单：用户经常使用非常错误（简单的）用户密码，全球最常用的密码是 123456 以及 bc123, 而且用户会在多个账户大量重复使用，所以黑客从别的地方盗取的密码很可能在其他账户也可以使用</strong></p>
<p><strong>使用 SSH kev 进行登录</strong><br />
 SSH key 采角了经典的非对称加密技术，可以使用工具创建一个公钥和私钥，你可以将公钥放置在任何的服务器当中，在本地保留私钥。在 ssh 登录的时候，SSH 验证公钥和私钥的合法性，当合法的时候，就可以免密码登录了。证书由 1024Bits 到 4096Bits（128 到 512 字符) 的随机字符组成，要比你自己的密码安全的多。</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#创建 ssh key pair</span></pre></td></tr><tr><td data-num="2"></td><td><pre>ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-b</span> <span class="token number">4096</span> <span class="token parameter variable">-C</span> <span class="token string">"your email@example.com"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>windows可以使用putty或者git scma软件生成，备注网址：</pre></td></tr><tr><td data-num="4"></td><td><pre>https://www.jianshu.com/p/95262f5eba7a</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 本地 ssh 证书的位置</span></pre></td></tr><tr><td data-num="6"></td><td><pre>-/.ssh/id rsa</pre></td></tr><tr><td data-num="7"></td><td><pre>-/.ssh/id rsa.pub</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># 登录远程机器</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token function">ssh</span> viking@xxx.xx.xx.xx</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 创建受信任的登录密钥</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 这个文件当中的公钥会被当前的主机设置为信任方</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token function">touch</span> -/.ssh/authorized keys</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 将 id rsa.pub 的文本内容黏贴进来</span></pre></td></tr></table></figure><p><strong>可选，关闭密码登录服务器的功能</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vim</span> /etc/ssh/sshd config</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#修改为 no</span></pre></td></tr><tr><td data-num="3"></td><td><pre>PasswordAuthentication no</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#重启服务</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">service</span> sshd i restart</pre></td></tr></table></figure><h4 id="使用-2"><a class="anchor" href="#使用-2">#</a> 使用</h4>
<p><strong>准备云服务器必备软件</strong></p>
<ul>
<li>nodejs (16)</li>
<li>MongoDB</li>
<li>Redis</li>
<li>Git</li>
</ul>
<p><strong>Linux 发行版的两大家族</strong></p>
<ul>
<li>Debian (完全免费的 Linux 发行版)-Ubuntu (基于 Debian, 更加容易上手)-apt 包管理系统 - 软件格式为 deb 包大</li>
<li>Red Hat (商用 Linux 发行版)-CentOS (Red Hat 减去收费软件)-yum 包管理系统 - 软件格式为 rpm</li>
</ul>
<p><strong>软件安装</strong><br />
<strong>安装 Node.js</strong><br />
1 安装 nvm 管理 node 版本 https://github.com/nvm-sh/nvm<br />
2 使用包管理器安装 node 最新版本 https://github.com/nodesource/distributions/blob/master/README.md#deb</p>
<p><strong>安装 MongoDB</strong><br />
1 从源代码下载安装，回顾之前的内容<br />
 2 使用包管理器安装<br />
 Ubuntu:<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1vbmdvZGIuY29tL21hbnVhbC90dXRvcmlhbC9pbnN0YWxsLW1vbmdvZGItb24tdWJ1bnR1Lw==">https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/</span><br />
Centos:<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1vbmdvZGIuY29tL21hbnVhbC90dXRvcmlhbC9pbnN0YWxsLW1vbmdvZGItb24tcmVkLWhhdC8=">https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/</span></p>
<p><strong>安装 Redis</strong><br />
1 从源代码下载安装，回顾之前的基础知识<br />
 2 使用包管理器安装<br />
 CentOS:<span class="exturl" data-url="aHR0cHM6Ly93d3cuZGlnaXRhbG9jZWFuLmNvbS9jb21tdW5pdHkvdHV0b3JpYWxzL2hvdy10by1pbnN0YWxsLXNlY3VyZS1yZWRpcy1jZW50b3MtNw==">https://www.digitalocean.com/community/tutorials/how-to-install-secure-redis-centos-7</span><br />
Ubuntu:<span class="exturl" data-url="aHR0cHM6Ly93d3cuZGlnaXRhbG9jZWFuLmNvbS9jb21tdW5pdHkvdHV0b3JpYWxzL2hvdy10by1pbnN0YWxsLWFuZC1zZWN1cmUtcmVkaXMtb24tdWJ1bnR1LTE4LTA0">https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04</span></p>
<h4 id="管理"><a class="anchor" href="#管理">#</a> 管理</h4>
<p><strong>使用 service 或者 systemctl 管理服务</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># systemd 模块 - https://en.wikipedia.org/wiki/Systemd</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">service</span>  服务名称<span class="token punctuation">(</span>mongod<span class="token punctuation">)</span>  操作指令<span class="token punctuation">(</span>status/start/stop/restart<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>systemctl  操作指令<span class="token punctuation">(</span>start/stop/status/restart/reload<span class="token punctuation">)</span>  服务名称service</pre></td></tr></table></figure><h1 id="普通部署"><a class="anchor" href="#普通部署">#</a> 普通部署</h1>
<p><strong>在服务器上部署并运行</strong></p>
<ul>
<li>
<p>登录远程机器，使用普通用户。</p>
</li>
<li>
<p>在自己的目录下面，clone 代码</p>
</li>
<li>
<p>安装对应的依赖</p>
<ul>
<li>
<p>可以使用 sharp 淘宝 mirror 来安装比较大的二进制文件。</p>
</li>
<li>
<p><span class="exturl" data-url="aHR0cHM6Ly9zaGFycC5waXhlbHBsdW1iaW5nLmNvbS9pbnN0YWxsI2NoaW5lc2UtbWlycm9y">https://sharp.pixelplumbing.com/install#chinese-mirror</span></p>
</li>
</ul>
</li>
<li>
<p>创建并且设置.env 文件</p>
</li>
<li>
<p>开启云服务对应的端口 (7001) 访问。</p>
<ul>
<li>
<p>阿里云：左侧导航 “本实例安全组”，“配置规则”，“手动添加 &quot; 端口</p>
</li>
<li>
<p>其他云平台请自行查看。</p>
</li>
</ul>
</li>
<li>
<p>启动服务器</p>
<ul>
<li>
<p>确认 mongo，redis 在运行状态</p>
</li>
<li>
<p>npm run tsc</p>
</li>
<li>
<p>npm run start</p>
</li>
</ul>
</li>
</ul>
<p>于此可以完成基本的项目部署，但是这种部署方式启动和更新时过于复杂，存在如下问题：</p>
<p>三个问题</p>
<ul>
<li>前置软件的安装，它们在不同操作系统中安装的方式，启动的脚本，预设初始的方式有可能都不相同，这就给我们造成一个很大的困扰，假如你在多台机器上部署的话，可能会遇到各种各样的问题。</li>
<li>项目需要运行一系列对应的命令才能启动</li>
<li>项目更新的问题，需要一系列手动的步骤，这是一个非常繁琐，而且容易出错的步骤。有没有更方便的方式可以完成这个过程呢？
<ul>
<li>完成对应的 pull 代码，更新依赖，启动应用的过程</li>
<li>是在特定的提交自动触发这个过程</li>
</ul>
</li>
</ul>
<p>想要更加方便的进行部署可以使用如下工具：</p>
<h2 id="docker"><a class="anchor" href="#docker">#</a> <span class="exturl" data-url="aHR0cHM6Ly93d3cuZG9ja2VyLmNvbS9wcm9kdWN0cy9kb2NrZXItZGVza3RvcA==">Docker</span></h2>
<h3 id="介绍-4"><a class="anchor" href="#介绍-4">#</a> 介绍</h3>
<p><strong>问题</strong><br />
我们希望有一个工具可以帮我们一键智能部署，假如你要部署在多台不同的机器上，可以不用在担心不同系统，不同版本的差异，以及运行之前需要安装不同软件的痛苦。<br />
<strong>解决</strong><br />
当红的虚拟化软件：<span class="exturl" data-url="aHR0cHM6L3d3dy5kb2NrZXIuY29tbA==">Docker</span><br />
Docker 的进化</p>
<p><img data-src="/images/Snipaste_2024-04-26_20-27-53.jpg" alt="Docker的进化" /></p>
<ul>
<li>传统虚拟机，虚拟硬件以后，需要在上面安装一个完整的操作系统。</li>
<li>Docker: 推出了容器的概念，每个容器不需要安装完成的操作系统，里面的进程直接运行在 Docker 创造的宿主内核中，不需要虚拟硬件。</li>
</ul>
<p><strong>Docker 的优点</strong></p>
<ul>
<li>更快速的启动速度</li>
<li>更少的资源占用</li>
<li>一致的运行环境，使用户不关注操作系统而只关心应用程序。</li>
<li>微服务架构，docker 天生适配微服务架构（Docker 有助于将一个复杂系统分解成一系列可组合的部分，这让用户可以用更离散的方式来思考其服务。用户可以在不影响全局的前提下重组软件，使其各部分更易于管理和可插拔。）</li>
<li>用户可以更准确地控制构建环境的状态，Docker 构建比传统软件构建方法更具有可重现性和可复制性。使持续交付的实现变得更容易。</li>
</ul>
<h3 id="docker-images"><a class="anchor" href="#docker-images">#</a> <strong>Docker  images</strong></h3>
<p>可以在 https://hub.docker.com/search?g=&amp;type=image 中获取各种官方的镜像，并且可以上传你自己的自定义镜像<br />
 Docker 镜像仓库获取镜像的命令是 docker pull</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 下载镜像</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">docker</span> pull <span class="token operator">&lt;</span>image-name<span class="token operator">></span>:<span class="token operator">&lt;</span>tag<span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 查看以及下载的镜像</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">docker</span> images</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 删除镜像</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">docker</span> rmi <span class="token operator">&lt;</span>image-id<span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 上传</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">docker</span> push <span class="token operator">&lt;</span>username<span class="token operator">></span>/<span class="token operator">&lt;</span>repository<span class="token operator">></span>:<span class="token operator">&lt;</span>tag<span class="token operator">></span></pre></td></tr></table></figure><p><strong>使用镜像代理：</strong></p>
<figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token property">"registry-mirrors"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token string">"https://docker.mirrors.ustc.edu.cn/"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token string">"https://reg-mirror.qiniu.com"</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">]</span></pre></td></tr></table></figure><h3 id="docker-container"><a class="anchor" href="#docker-container">#</a> <strong>Docker Container</strong></h3>
<p><strong>启动 Docker 容器</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> 主机端口:镜像端口 <span class="token parameter variable">--name</span> 容器名称 镜像名称</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 例如：（--name 容器名称省略）</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">81</span>:80 nginx</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># -d  后台运行</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># -p  端口映射，81 为主机的端口，80 为镜像端口</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># --name 自定义容器名称</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 镜像名称，假如本地没有，会自动 pull 一次镜像进行下载。</span></pre></td></tr></table></figure><p><strong>其他命令</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 查看所有容器</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">docker</span>  <span class="token function">ps</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 停止容器</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">docker</span> stop container-id</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 删除容器</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">docker</span> <span class="token function">rm</span> container-id</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 启动已终止容器</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">docker</span> container start container-id</pre></td></tr></table></figure><p><strong>进入容器内部</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>container-id<span class="token operator">></span> <span class="token builtin class-name">command</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token parameter variable">-i</span> <span class="token builtin class-name">:</span> 即使没有附加也保持STDIN 打开</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token parameter variable">-t</span> <span class="token builtin class-name">:</span> 分配一个伪终端</pre></td></tr></table></figure><h3 id="持久化容器数据"><a class="anchor" href="#持久化容器数据">#</a> <strong>持久化容器数据</strong></h3>
<p>使用 - v 参数，可以设定一个数据的映射关系，将本地的文件映射到容器中对应的文件中去。</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">81</span>:80 <span class="token parameter variable">-v</span> host:container image-name</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#例如：将本地数据卷映射到容器中</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-v</span> /data/db:/data/db mongo</pre></td></tr></table></figure><p><strong>创建对应的数据卷 volumn</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建数据卷</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">docker</span> volume create <span class="token operator">&lt;</span>volumn-name<span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#例如：docker volume create mongo</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 使用 volumn 数据卷</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-v</span> <span class="token operator">&lt;</span>volumn-name<span class="token operator">></span>:/data/db mongo</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 例如：docker run -d -v mongo:/data/db mongo</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 检查数据卷</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">docker</span> volume inspect <span class="token operator">&lt;</span>volumn-name<span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 删除数据卷</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">docker</span> volume remove mongo</pre></td></tr></table></figure><h3 id="dockerfile自定义镜像"><a class="anchor" href="#dockerfile自定义镜像">#</a> Dockerfile 自定义镜像</h3>
<p>Docker image 中的镜像虽然非常多，但是不能完全符合自己项目的全部需求，可以自定义构建一个自己的镜像。</p>
<p>Dockerfile 是一个特殊的文本文件，其中包括一系列指令，用于构建对应的镜像。</p>
<p><strong><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL3JlZmVyZW5jZS9idWlsZGVyLyNmcm9t">指令</span></strong></p>
<p><strong>Dockerfile 示例：</strong></p>
<figure class="highlight dockerfile"><figcaption data-lang="Docker"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 指定基础镜像，从 node14 开始构建</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token instruction"><span class="token keyword">FROM</span> node:14</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 创建对应的文件夹，作为项目运行的位置</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token instruction"><span class="token keyword">RUN</span> mkdir -p /usr/src/app</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 指定工作区，后面的运行任何命令都是在这个工作区中完成的</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token instruction"><span class="token keyword">WORKDIR</span> /usr/sec/app</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 从本地拷贝对应的文件 到 工作区</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> server.js /usr/src/app</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 执行安装命令</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token instruction"><span class="token keyword">RUN</span> npm install --registry=https://registry.npm.taobao.org</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token instruction"><span class="token keyword">RUN</span> npm run tsc</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">#告知当前 Docker image 暴露的是 3000 端☐</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token instruction"><span class="token keyword">EXPOSE</span> 3000</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">#执行启动命令，一个 Dockerfile 只能有一个</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token instruction"><span class="token keyword">CMD</span> node server.js</span></pre></td></tr></table></figure><p><strong>构建：</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 这里特别注意上下文的概念，不要在根目录使用 Dockerfi1e</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">docker</span> build <span class="token punctuation">[</span>选项<span class="token punctuation">]</span> <span class="token operator">&lt;</span>上下文路径/URL/-<span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 例如：(在项目文件夹中运行)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">docker</span> build <span class="token parameter variable">-t</span> test-node <span class="token builtin class-name">.</span></pre></td></tr></table></figure><p><strong>.dockerignore 文件用于忽略 docker 中需要打包进镜像的文件</strong></p>
<p><strong>.dockerignore 示例：</strong></p>
<figure class="highlight dockerfile"><figcaption data-lang="Docker"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Microbundle cache</span></pre></td></tr><tr><td data-num="2"></td><td><pre>.rpt2_cache/</pre></td></tr><tr><td data-num="3"></td><td><pre>.rts2_cache_cjs/</pre></td></tr><tr><td data-num="4"></td><td><pre>.rts2_cache_es/</pre></td></tr><tr><td data-num="5"></td><td><pre>.rts2_cache_umd/</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># Optional REPL history</span></pre></td></tr><tr><td data-num="7"></td><td><pre>.node_repl_history</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># Output of 'npm pack'</span></pre></td></tr><tr><td data-num="9"></td><td><pre>*.tgz</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># Yarn Integrity file</span></pre></td></tr><tr><td data-num="11"></td><td><pre>.yarn-integrity</pre></td></tr></table></figure><p><strong>多个容器相互通信：</strong></p>
<p>要点：Docker 中每一个 container 应该只完成一个工作，并且将它做好。</p>
<p><strong>优点：</strong></p>
<ul>
<li>解耦，这样不同的服务和后端代砀都可以完全分离开来，方便管理以及未来的扩展。</li>
<li>服务的更新以及升级都是完全独立的。</li>
<li>在一个 container 中，启动多个不同的进程，需要一个进程管理器</li>
</ul>
<p><strong>通信过程：</strong></p>
<p>docker 容器之间不能直接进行访问，而是应该通过 docker 网络进行访问。</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建 docker 网络</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">docker</span> network create <span class="token builtin class-name">test</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 在创建的 docker 网络中启动服务</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--network</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">--name</span> mongo <span class="token parameter variable">-p</span> <span class="token number">27017</span>:27017 mongo</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 将原来项目中的的 ip 地址替换为 docker 的 name 名称</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 例如原来为：mongodb://localhost:27017/api  的地址要替换为： mongodb://mongo:27017/api</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 只有在同一个 docker 网络中启动的项目间才能进行访问。</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--network</span> <span class="token builtin class-name">test</span> <span class="token parameter variable">--name</span> use <span class="token parameter variable">-p</span> <span class="token number">80</span>:3000 use</pre></td></tr></table></figure><p>如果每个容器都要这样操作一遍就会显得非常麻烦，这时就需要使用 Docer compose 工具（配置 docker-compose.yml 文件）</p>
<p>Docker compose 工具</p>
<p>Docker compose 是 Docker 官方推出的工具，用来管理和共享多个容器的应用，Mac 系统和 Windows 系统安装客户端时自带。<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vY29tcG9zZS9pbnN0YWxsLw==">Linux 需要单独安装</span>。</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">docker-compose</span> version</pre></td></tr></table></figure><p><strong>配置：</strong></p>
<ul>
<li>docker compose 通过一个特殊的 yml 文件，进行配置，这个文件必须命名为<strong> docker-compose.yml</strong></li>
<li>docker-compose 所有的字段参考文档：<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vY29tcG9zZS9jb21wb3NlLWZpbGUvY29tcG9zZS1maWxlLXYzLw==">https://docs.docker.com/compose/compose-file/compose-file-v3/</span></li>
</ul>
<p><strong>docker-compose.yml 文件配置示例：</strong></p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span> <span class="token comment"># docker 指令版本</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span> <span class="token comment"># 要启动的服务</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">test-mongo</span><span class="token punctuation">:</span> <span class="token comment"># 服务名称，这里的服务名称对应着容器通信时的前缀！</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> mongo <span class="token comment"># 使用的镜像名称</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>mongo <span class="token comment"># 容器名称</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token comment"># 使用的数据卷映射</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">'.docker-volumes/mongo/data:/data/db'</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token comment"># 端口映射</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">-</span> 27017<span class="token punctuation">:</span><span class="token number">27017</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token comment"># 设置环境变量</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> MONGO_INITDB_ROOT_USERNAME=admin  <span class="token comment"># 内置的环境变量，可以初始化添加一个 User</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">-</span> MONGO_INITDB_ROOT_PASSWORD=pass</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">env_file</span><span class="token punctuation">:</span> <span class="token comment"># 设置环境变量文件，将敏感信息放置到环境变量文件中</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> .env</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">test-use</span><span class="token punctuation">:</span> <span class="token comment"># 第二个项目，注意对齐关系</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token comment"># 配置所依赖的服务</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">-</span> test<span class="token punctuation">-</span>mongo</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span> <span class="token comment"># 设置构建配置</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token key atrule">context</span><span class="token punctuation">:</span> . <span class="token comment"># 操作上下文为当前目录</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile <span class="token comment"># 基于 Dockerfile 进行构建</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>use<span class="token punctuation">-</span>image</pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>use</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token punctuation">-</span> 7001<span class="token punctuation">:</span><span class="token number">7001</span></pre></td></tr></table></figure><p><strong>启动以及关闭：</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 启动</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 关闭</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">docker-compose</span> down</pre></td></tr></table></figure><h3 id="数据库配置"><a class="anchor" href="#数据库配置">#</a> 数据库配置</h3>
<p><strong>数据库准备工作</strong></p>
<ul>
<li>数据库配置，初始化工作，比如插入一些特定的数据</li>
<li>避免使用 root 用户去启动服务，从而提高安全性（配置数据库访问权限）</li>
</ul>
<p><strong>特殊的初始化数据库的位置：/docker-entrypoint-initdb.d（这个文件夹中的脚本会在容器启动前自动执行）</strong></p>
<ul>
<li>
<p>可以创建 js 文件或者 sh 文件（shell）进行执行。</p>
</li>
<li>
<p>mongoDB：<span class="exturl" data-url="aHR0cHM6Ly9odWIuZG9ja2VyLmNvbS9fbW9uZ28=">https://hub.docker.com/_mongo</span></p>
</li>
<li>
<p>Postgres:<span class="exturl" data-url="aHR0cHM6Ly9odWIuZG9ja2VyLmNvbS9fbHBvc3RncmVz">https://hub.docker.com/_lpostgres</span></p>
</li>
<li>
<p>特别注意，只有在数据库没有被创建的情况下，也就是<strong>数据库的文件夹是空的情况下</strong>，脚本才会被执行。</p>
</li>
</ul>
<p><strong>docker-compose.yml 文件中配置 env_file 为当前文件夹下的.env 文件。</strong></p>
<p>可以使用 js 文件或者 sh 文件，但是由于此文件在其余文件之前运行，此时 js 文件中通过 process.env 获取不到所需要的环境变量，可以选用 sh 文件。</p>
<p><strong>Shell 中 EOF&lt;&lt; 的用法</strong><br />
在 Shell 中我们通常将 EOF 与 &lt; 结合使用，表示，二债的输入作为子命令或子 Shell 的输入，直到遇到 EOF 为止，再返回到主调 Shell。.</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token shebang important">#!/bin/bash</span></pre></td></tr><tr><td data-num="2"></td><td><pre>mongo <span class="token operator">&lt;&lt;</span><span class="token string">EOF</pre></td></tr><tr><td data-num="3"></td><td><pre>use admin</pre></td></tr><tr><td data-num="4"></td><td><pre>db.auth('root','123456')</pre></td></tr><tr><td data-num="5"></td><td><pre>use lego</pre></td></tr><tr><td data-num="6"></td><td><pre>db.createUser(&#123;</pre></td></tr><tr><td data-num="7"></td><td><pre>	user: '<span class="token variable">$MONGO_DB_USERNAME</span>',</pre></td></tr><tr><td data-num="8"></td><td><pre>	pwd: '<span class="token variable">$MONGO_DB_PASSWORD</span>',</pre></td></tr><tr><td data-num="9"></td><td><pre>	roles: [&#123;</pre></td></tr><tr><td data-num="10"></td><td><pre>		role: 'readWrite',</pre></td></tr><tr><td data-num="11"></td><td><pre>		db: 'lego'</pre></td></tr><tr><td data-num="12"></td><td><pre>	&#125;]</pre></td></tr><tr><td data-num="13"></td><td><pre>&#125;)</pre></td></tr><tr><td data-num="14"></td><td><pre>db.createCollection('works')</pre></td></tr><tr><td data-num="15"></td><td><pre>db.works.insertMany([</pre></td></tr><tr><td data-num="16"></td><td><pre>	&#123;</pre></td></tr><tr><td data-num="17"></td><td><pre>  		id:19,</pre></td></tr><tr><td data-num="18"></td><td><pre>  		title:'测试标题',</pre></td></tr><tr><td data-num="19"></td><td><pre>  		name:'张三'</pre></td></tr><tr><td data-num="20"></td><td><pre>	&#125;</pre></td></tr><tr><td data-num="21"></td><td><pre>])</pre></td></tr><tr><td data-num="22"></td><td><pre>EOF</span></pre></td></tr></table></figure><h3 id="优化镜像大小"><a class="anchor" href="#优化镜像大小">#</a> 优化镜像大小</h3>
<p><strong>Docker 镜像构建优化：使用 alpine 版本的镜像</strong></p>
<p>优化镜像大小  ：   什么是 Alpine Linux:<span class="exturl" data-url="aHR0cHM6Ly9hbHBpbmVsaW51eC5vcmc=">https://alpinelinux.org</span></p>
<p><strong>Alpine 的优点</strong></p>
<ul>
<li>
<p>Small 小</p>
<ul>
<li>
<p>默认软件包，alpine 选择 busybox</p>
</li>
<li>
<p>C 运行库，一般会用 glibc,alpine 选择 musl</p>
</li>
</ul>
</li>
<li>
<p>最简依赖，Simple</p>
<ul>
<li>
<p>很多内置软件的插件都去掉。</p>
</li>
<li>
<p>国际化内容都被删除</p>
</li>
</ul>
</li>
<li>
<p>Secure 安全</p>
</li>
</ul>
<p><strong>使用 alpine 版本的镜像可以大大减小镜像的体积。</strong></p>
<p><strong>DockerBuild 构建提速</strong></p>
<p>docker 中运行命令是基于一层一层的，当修改文件之后，COPY 后的缓存全部失效，这时就会重新执行后续命令，使用不了缓存，导致构建速度很慢。此时可以将原来 COPY 文件夹，改为 COPY 具体的文件（进行拆分），以更好地使用缓存。</p>
<h3 id="部署-3"><a class="anchor" href="#部署-3">#</a> 部署</h3>
<p><strong>安装 Docker（有的云服务可以自定义安装）</strong></p>
<p>Ubuntu：（需要使用 root 账户进行安装）</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS9kb2NrZXIvdWJ1bnR1LWRvY2tlci1pbnN0YWxsLmh0bWw=">https://www.runoob.com/docker/ubuntu-docker-install.html</span></li>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL2luc3RhbGwvdWJ1bnR1Lw==">https://docs.docker.com/engine/install/ubuntu/</span></li>
</ul>
<p><strong>配置用户组</strong><br />
因为是 root 安装，普通用户执行对应的命令的时候有可能会报错：<br />
 <code>Can't connect to docker daemonGot permission denied while trying to connect to the Docker daemonsocket at unix:///var/run/docker.sock</code></p>
<p><strong>需要将对应的用户添加到 docker 的用户组中。</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#usermod 命令修改用户账户</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#a--append 添加 - G--groups</span></pre></td></tr><tr><td data-num="3"></td><td><pre>组的名称</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">sudo</span> usermod-aG <span class="token function">docker</span> 你的用户名</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#如果组不存在，添加对应的 docker 组</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">sudo</span> <span class="token function">groupadd</span> <span class="token function">docker</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#查看一个用户所属的组</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">groups</span></pre></td></tr></table></figure><p><strong>添加下载镜像：</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># root</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">vim</span> /etc/docker/daemon.json</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token string">"https://docker.mirrors.ustc.edu.cn/"</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token string">"https://reg-mirror.qiniu.com"</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">]</span></pre></td></tr></table></figure><p><strong>运行：</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 拉最新的代码</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">git</span> pull</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 先查看目前端口是否被占用</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 如果被占用，释放端口</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 或者改变 docker-compose,yml 的映射端口</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span></pre></td></tr></table></figure><h1 id="yaml语言"><a class="anchor" href="#yaml语言">#</a> YAML 语言</h1>
<p>YAML<br />
 (YAML Ain't a Markup Language) 是一种标记语言，它使用空格作为缩进，看起来非常的简洁，可读性非常的好，非常适合一些内容大纲和配置文件。他最终是通过工具转化为 JSON 文件的，但是 YAML 的可读性比 JSON 强很多，因此复杂的配置文件一般使用 YAML。</p>
<p><strong>例如：</strong></p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 字符串不用加引号</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">key</span><span class="token punctuation">:</span> value</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">100</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">boolean</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 字符串不用加引号，但是加上也不会报错</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">quote_string</span><span class="token punctuation">:</span> <span class="token string">'quote String'</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 多行字符串使用 literal block 语法：也就是竖线</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">mutiple_string</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></pre></td></tr><tr><td data-num="9"></td><td><pre>  line one</pre></td></tr><tr><td data-num="10"></td><td><pre>  line two</pre></td></tr><tr><td data-num="11"></td><td><pre>  line three</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># collection types 集合类型</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 使用缩进表示层级关系，最好使用两个空格，不是两个空格也没关系，对齐就行</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token key atrule">person</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dmq</pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token key atrule">age</span><span class="token punctuation">:</span> <span class="token number">18</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token key atrule">address</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">city</span><span class="token punctuation">:</span> 上海</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># sequences 数组或者列表</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token key atrule">hobbies</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token punctuation">-</span> Item 1</pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token punctuation">-</span> Item 2</pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> weson</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token key atrule">value</span><span class="token punctuation">:</span> xyz</pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token key atrule">address</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token key atrule">city</span><span class="token punctuation">:</span> 北京</pre></td></tr></table></figure><h1 id="github-action"><a class="anchor" href="#github-action">#</a> Github Action</h1>
<p>Github 官方的 CI/CD 工具，作为 github 的亲儿子，和 github 几乎是完美的无缝衔接的，功能非常强大。</p>
<p>CI   CD 常用工具：</p>
<ul>
<li>Github actions <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vZW4vYWN0aW9ucw==">https://docs.github.com/en/actions</span></li>
<li>Travis <span class="exturl" data-url="aHR0cHM6Ly93d3cudHJhdmlzLWNpLmNvbS8=">https://www.travis-ci.com/</span></li>
<li>CircleCl <span class="exturl" data-url="aHR0cHM6Ly9jaXJjbGVjaS5jb20v">https://circleci.com/</span></li>
<li>Jenkins <span class="exturl" data-url="aHR0cHM6Ly93d3cuamVua2lucy5pby8=">https://www.jenkins.io/</span></li>
<li>优势讨论：<span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzMwNjE5NTAzMy9hbnN3ZXIvMTg3MDMyMjExOA==">https://www.zhihu.com/question/306195033/answer/1870322118</span></li>
</ul>
<p><img data-src="/images/Snipaste_2024-04-27_18-37-04.jpg" alt="/images/Snipaste_2024-04-16_12-54-33.jpg" /></p>
<p><strong>Workflow</strong><br />
<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vY24vYWN0aW9ucy9sZWFybi1naXRodWItYWN0aW9ucy91bmRlcnN0YW5kaW5nLWdpdGh1Yi1hY3Rpb25zI3dvcmtmbG93cw==">https://docs.github.com/cn/actions/learn-github-actions/understanding-github-actions#workflows</span><br />
Workflow 是一个可配置的自动化流程，可以包含多个 jobs, 通过一个在 repo 当中的 yml 文件来定义对应的流程，一个 repo 可以包含多个 workflow。<br />
<strong>Events</strong><br />
Event 是触发 workflow 的特殊事件，比如 pull request,push 或者 issue, 也可以完全自定义，完整列表请看：https:/docs.github.com/cn/actions/learn-github-actions/events-that-trigger-workflows</p>
<p><strong>Jobs</strong></p>
<p>Job 是 Workflow 当中一系列的可执行步骤，每个 Job 是在同一个 runner 中进行的（(Runner 是指处于 github 的一台特殊的虚拟机，支持各种操作系统)，每个步骤或者是一个 shell 脚本，抑或是一个可执行的 action, 每个步骤是按顺序执行，并且互相依赖的。</p>
<p><img data-src="/images/Snipaste_2024-04-27_19-54-06.jpg" alt="/images/Snipaste_2024-04-16_12-54-33.jpg" /></p>
<p><strong>Actions</strong></p>
<p>Action 是 github actions 中的一个自定义应用，它可以运行一系列复杂的并且常用的任务，使用 action 可以帮我们减少在 workflow 中写重复代码，Github 提供了非常多常用的 action, 可以在<span class="exturl" data-url="aHR0cHM6Z2l0aHViLmNvbS9tYXJrZXRwbGFjZT90eXBlPWFjdGlvbnM=">这里查阅</span>，同时我们也可以写自己的 action。</p>
<p><strong>github secrets</strong></p>
<p>项目中有的私密信息不希望公开暴露，通常的做法是将私密信息写道 env 文件中，使用 gitingore 将其忽略掉，这里还有一个做法就是 github secrets，在 github 官网设置 github secret，然后在文件中直接书写变量。</p>
<p><strong>例如：.github 文件夹下 workflow 文件夹下创建一个 yml 文件，写入：</strong></p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">name</span><span class="token punctuation">:</span> Github Actions Demo</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>push<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">jobs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">Check-Github-actions</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">steps</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> echo "triggered by a $&lt;<span class="token tag">!--swig</span>￼5<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span> event"</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> echo "running on a $&lt;<span class="token tag">!--swig</span>￼6<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span> server hosted by github"</pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> check out repo code</pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2 <span class="token comment"># 在工作流程中检出代码仓库的内容、确保工作流程始终使用一致的代码版本</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> echo "the $&lt;<span class="token tag">!--swig</span>￼7<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span> has been cloned"</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> List files in the repo</pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></pre></td></tr><tr><td data-num="14"></td><td><pre>          ls $</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">steps</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2</pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token key atrule">width</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token key atrule">repository</span><span class="token punctuation">:</span> <span class="token string">'vikingmute/lego-bricks'</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> List files in the repo</pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></pre></td></tr><tr><td data-num="23"></td><td><pre>          ls $</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v2</pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token key atrule">with</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">'16'</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> node <span class="token punctuation">-</span>v</pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> npm install <span class="token punctuation">-</span>g typescript</pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> tsc <span class="token punctuation">-</span>v</pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token key atrule">jobs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token key atrule">SECRET-SSH-ACTIONS</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest</pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token key atrule">steps</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token comment">#使用 ssh-action 完成远程登陆：文档地址：https://github.com/appleboy/ssh-action</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> appleboy/ssh<span class="token punctuation">-</span>action@master </pre></td></tr><tr><td data-num="36"></td><td><pre>          <span class="token key atrule">with</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token key atrule">host</span><span class="token punctuation">:</span> $&lt;<span class="token tag">!--swig</span>￼10<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span><span class="token scalar string"></pre></td></tr><tr><td data-num="38"></td><td><pre>            username: $</pre></td></tr><tr><td data-num="39"></td><td><pre>            password: $</pre></td></tr><tr><td data-num="40"></td><td><pre>            script_stop: true</pre></td></tr><tr><td data-num="41"></td><td><pre>            script: |</pre></td></tr><tr><td data-num="42"></td><td><pre>              pwd</pre></td></tr><tr><td data-num="43"></td><td><pre>              ls -l</pre></td></tr><tr><td data-num="44"></td><td><pre>              touch secret.txt</pre></td></tr><tr><td data-num="45"></td><td><pre>              echo $ >> secret.txt</span></pre></td></tr></table></figure><h1 id="自动化部署"><a class="anchor" href="#自动化部署">#</a> 自动化部署</h1>
<h2 id="推送远程镜像仓库"><a class="anchor" href="#推送远程镜像仓库">#</a> 推送远程镜像仓库</h2>
<p><strong>普通线上更新流程：</strong></p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 每次代码更新以后，登录到 ssh 服务器</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 关闭服务</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">docker-compose</span> down</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># 更新代码</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">git</span> pull</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># 假如有.env，的更新需要重新设置，env 文件</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 重新 build 应用镜像</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">docker-compose</span> build lego-backend</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 重启服务</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span></pre></td></tr></table></figure><p><strong>弊端：</strong></p>
<ul>
<li>
<p>初次上线和更新属于两步</p>
</li>
<li>
<p>初次上线需要特别的操作，就是之前手动部署上线的运行的过程</p>
<ul>
<li>
<p>clone 代码</p>
</li>
<li>
<p>设置环境变量.env</p>
</li>
<li>
<p>docker-compose up -d</p>
</li>
</ul>
</li>
</ul>
<p><strong>追求的成果：</strong></p>
<p><strong>每次提交，可以自动一次性的部署到任何服务器，实现初次启动或者更新的效果，这才是一个完美的 develops 的流程</strong></p>
<p><strong>解决方案：</strong></p>
<p>将上面本地的镜像存到 docker hub 服务器中，这样每次就不用重新 build，而是直接拉取。</p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">lego-redis</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    image<span class="token punctuation">:</span>redis<span class="token punctuation">:</span><span class="token number">6</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">lego-mongo</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    image<span class="token punctuation">:</span>mongo<span class="token punctuation">:</span>latest</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">lego-backend</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    image<span class="token punctuation">:</span>lego<span class="token punctuation">-</span>backend</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">#我们需要每次手动的 build 镜像，也就说镜像只存在于本地</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">...</span><span class="token punctuation">...</span>context<span class="token punctuation">:</span>.</pre></td></tr><tr><td data-num="11"></td><td><pre>    dockerfile<span class="token punctuation">:</span>Dockerfile</pre></td></tr></table></figure><p><strong>改为：</strong></p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 更好的方案</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 不需要任何代码库中的文件，只需要一个 docker-compose.yml 文件</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 就可以轻松的在任何服务器运行</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">lego-redis</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    image<span class="token punctuation">:</span>redis<span class="token punctuation">:</span><span class="token number">6</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  lego<span class="token punctuation">-</span>mongo</pre></td></tr><tr><td data-num="8"></td><td><pre>    image<span class="token punctuation">:</span>mongo<span class="token punctuation">:</span>latest</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">lego-backend</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment"># 不需要 build, 而是存在于 docker hub 服务器中，可以每次直接拉取</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    image<span class="token punctuation">:</span>lego<span class="token punctuation">-</span>backend<span class="token punctuation">:</span>1.0.1</pre></td></tr></table></figure><p><strong>docker hub 免费版有限制，推荐使用阿里云容器镜像服务：</strong></p>
<p><strong><span class="exturl" data-url="aHR0cHM6bFd3dy5hbGl5dW4uY29tL3Byb2R1Y3QvYWNy">阿里云容器镜像服务 ACR</span></strong><br />
 个人版完全免费</p>
<p>创建镜像仓库之后，需要将本地镜像推送到 ACR 仓库中：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 来到镜像仓库的基本信息页面</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># 登录</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">docker</span> login <span class="token parameter variable">--username</span><span class="token operator">=</span>用户名 registry.cn-hangzhou.aliyuncs.com</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># tag 两种方式：</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 1: 使用 tag bui1d</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">docker</span> build--tag <span class="token string">"registry.cn-hangzhou.aliyuncs.com/dmq00/test:[镜像版本号]"</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 2: 给 build 好的打 tag</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">docker</span> tag <span class="token punctuation">[</span>ImageId<span class="token punctuation">]</span> registry.cn-hangzhou.aliyuncs.com/dmq00/test:<span class="token punctuation">[</span>镜像版本号<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment"># 查看镜像是否 build 完成</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">docker</span> images</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># 推送镜像</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token function">docker</span> push registry.cn-hangzhou.aliyuncs.com/dmq00/test:<span class="token punctuation">[</span>镜像版本号<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># 在阿里云 ACR 界面检查看是否已经存在</span></pre></td></tr></table></figure><h2 id="github-actions自动部署"><a class="anchor" href="#github-actions自动部署">#</a> Github Actions 自动部署</h2>
<p><strong>使用 github actions 加成自动化部署：当推送代码到 github 仓库时，让我们的代码自动提交镜像到镜像仓库。</strong></p>
<p><strong>大体分为两步</strong></p>
<ul>
<li>
<h6 id="在github服务器上build-image并且push"><a class="anchor" href="#在github服务器上build-image并且push">#</a> 在 github 服务器上 build image 并且 push</h6>
</li>
<li>
<p><strong>使用 docker-compose-online 文件在服务器上运行应用</strong></p>
</li>
</ul>
<p><strong>第一步详细流程分析，在 github runner 上运行</strong></p>
<ul>
<li>
<p>checkout 代码（在 github 服务器上）</p>
</li>
<li>
<p>创建.env 文件，并且添加两个环境变量 (upload to OSS 需要两个对应的信息)</p>
</li>
<li>
<p>使用阿里云 ACR 完成 docker login</p>
</li>
<li>
<p>使用正确的阿里云 tag 进行 docker build</p>
<ul>
<li>怎样每次 push 生成特殊的 tag？是一个后续的问题</li>
</ul>
</li>
<li>
<p>docker push</p>
</li>
</ul>
<p>例如：【1】在项目文件夹.github/workflow 下创建 yml 文件，写入：</p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">name</span><span class="token punctuation">:</span> build image<span class="token punctuation">,</span>push to ACR</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">on</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>push<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">jobs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">build-and-push</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">steps</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token comment"># checkout 代码</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2</pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token comment"># 创建 env 文件</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> touch .env</pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token comment"># 使用 “>> ” 添加信息</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> echo ALC_ACCESS_KEY=$&lt;<span class="token tag">!--swig</span>￼14<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span> <span class="token punctuation">></span><span class="token punctuation">></span> .env</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">run</span><span class="token punctuation">:</span> echo ALC_SECRET_KEY=$&lt;<span class="token tag">!--swig</span>￼15<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">></span> <span class="token punctuation">></span><span class="token punctuation">></span> .env</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token comment"># 使用阿里云 ACR 完成 docker login</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Login to Aliyun ACR</pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> aliyun/acr<span class="token punctuation">-</span>login@v1 <span class="token comment"># 使用专属的镜像</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">with</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token key atrule">login-server</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com</pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token key atrule">region-id</span><span class="token punctuation">:</span> cn<span class="token punctuation">-</span>hangzhou <span class="token comment"># 查看官网自己仓库的信息</span></pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"$"</span></pre></td></tr><tr><td data-num="21"></td><td><pre>          <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"$"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment"># 使用正确的阿里云 tag 进行 docker build</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build image for Docker</pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token key atrule">run</span><span class="token punctuation">:</span> docker build <span class="token punctuation">-</span><span class="token punctuation">-</span>tag "registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com/dmq00/test<span class="token punctuation">:</span>0.0.2"</pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Push Image to ACR</pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token key atrule">run</span><span class="token punctuation">:</span> docker push registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com/dmq00/test<span class="token punctuation">:</span>0.0.2</pre></td></tr></table></figure><p>这样就能保证代码 push 到 github 上之后自动将镜像推送到 docker 镜像仓库，结合 dockerfile 文件就能保证使用 docker 镜像时自动执行命令，安装对应依赖并执行项目。</p>
<p><strong>第二步详细流程分析，在服务器上部署对应的代码并且运行</strong></p>
<ul>
<li>
<p>checkout 代码</p>
</li>
<li>
<p>创建.env 文件，添加多个环境变量。(应用所有需要的环境变量)，github  secrets 中添加。</p>
</li>
<li>
<p>创建文件夹，拷贝如下文件到文件夹内</p>
<ul>
<li>.env</li>
<li>docker-compose-online.yml</li>
<li>mongo-entrypoint 文件夹</li>
</ul>
</li>
<li>
<p>将新建的文件夹拷贝到服务器 (SCP) 当中</p>
<ul>
<li>使用 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FwcGxlYm95L3NjcC1hY3Rpb24=">https://github.com/appleboy/scp-action</span></li>
</ul>
</li>
<li>
<p>SSH 到服务器中</p>
<ul>
<li>进入拷贝的文件夹内</li>
<li>登录阿里云 ACR</li>
<li>停止服务 docker-compose down （第一次的话，没有启动也不会报错）</li>
<li>启动服务 docker-compose up</li>
<li>清理工作可选，保证安全（删除.env 文件，登出 docker 账户）</li>
</ul>
</li>
</ul>
<p><strong>后续过程需要完成：</strong></p>
<ul>
<li>
<p>在 push tags 的时候才触发对应的 job</p>
<p>：<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vY24vYWN0aW9ucy9sZWFybi1naXRodWItYWN0aW9ucy9ldmVudHMtdGhhdC10cmlnZ2VyLXdvcmtmbG93cw==">https://docs.github.com/cn/actions/learn-github-actions/events-that-trigger-workflows</span></p>
</li>
<li>
<p>怎样获取对应的每次提交相关的特殊信息</p>
<p>：<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGh1Yi5jb20vZW4vYWN0aW9ucy9sZWFybi1naXRodWItYWN0aW9ucy9jb250ZXh0cw==">https://docs.github.com/en/actions/learn-github-actions/contexts</span></p>
</li>
<li>
<p>使用这个特殊信息，在对应的 docker-compose-online.yml 中进行替换，将要启动的版本替换为将要构建的版本。</p>
</li>
</ul>

      <div class="tags">
          <a href="/tags/%E5%A4%8D%E6%9D%82%E4%B8%9A%E5%8A%A1%E9%83%A8%E7%BD%B2%E4%B8%8E%E4%BC%98%E5%8C%96/" rel="tag"><i class="ic i-tag"></i> 复杂业务部署与优化</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2024-07-09 13:16:59" itemprop="dateModified" datetime="2024-07-09T13:16:59+08:00">2024-07-09</time>
  </span>
  <span id="2024/04/12/复杂项目部署上线/" class="item leancloud_visitors" data-flag-title="复杂业务部署与优化" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="dmq 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="dmq 支付宝">
        <p>支付宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>dmq <i class="ic i-at"><em>@</em></i>杜明清的个人博客
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://dmqweb.cn/2024/04/12/%E5%A4%8D%E6%9D%82%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B8%8A%E7%BA%BF/" title="复杂业务部署与优化">https://dmqweb.cn/2024/04/12/复杂项目部署上线/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2024/03/30/jest/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s3.uuu.ovh&#x2F;imgs&#x2F;2024&#x2F;04&#x2F;05&#x2F;f58f811a8b6cbdbb.jpg" title="jest">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> TDD</span>
  <h3>jest</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2024/04/12/%E8%84%9A%E6%89%8B%E6%9E%B6/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s3.uuu.ovh&#x2F;imgs&#x2F;2024&#x2F;04&#x2F;05&#x2F;d389418a13d92e24.jpg" title="脚手架开发">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> 脚手架开发</span>
  <h3>脚手架开发</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.</span> <span class="toc-text"> 软件生命周期：</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">2.</span> <span class="toc-text"> 架构流程图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E9%A1%B9%E7%9B%AE%E9%80%9A%E7%94%A8%E6%96%B9%E6%A1%88"><span class="toc-number">3.</span> <span class="toc-text"> 复杂项目通用方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%9A%84%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">3.0.0.1.</span> <span class="toc-text"> 业务的复杂度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E7%9A%84%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">3.0.0.2.</span> <span class="toc-text"> 流程的复杂度</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ci-cd%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">4.</span> <span class="toc-text"> CI &#x2F; CD 的概念</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#cicontinuous-integration%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90"><span class="toc-number">4.0.0.1.</span> <span class="toc-text"> CI（Continuous integration）持续集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cdcontinuous-delivery%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98"><span class="toc-number">4.0.0.2.</span> <span class="toc-text"> CD（Continuous Delivery）持续交付</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cdcontinuous-deployment%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2"><span class="toc-number">4.0.0.3.</span> <span class="toc-text"> CD（Continuous Deployment）持续部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ci-cd%E4%B8%A4%E5%A4%A7%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.0.0.4.</span> <span class="toc-text"> CI &#x2F; CD 两大服务：</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%97%E8%A1%A8%E6%8E%92%E5%BA%8F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">5.</span> <span class="toc-text"> 列表排序解决方案</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8B%96%E5%8A%A8%E6%94%B9%E5%8F%98%E4%BD%8D%E7%BD%AE%E5%8E%9F%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text"> 拖动改变位置原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8B%96%E5%8A%A8%E6%94%B9%E5%8F%98%E5%A4%A7%E5%B0%8F%E5%8E%9F%E7%90%86"><span class="toc-number">7.</span> <span class="toc-text"> 拖动改变大小原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BF%AB%E6%8D%B7%E9%94%AE%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">8.</span> <span class="toc-text"> 快捷键实现原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%92%A4%E9%94%80%E9%87%8D%E5%81%9A%E5%8E%9F%E7%90%86"><span class="toc-number">9.</span> <span class="toc-text"> 撤销重做原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%B3%E9%94%AE%E8%8F%9C%E5%8D%95%E5%8E%9F%E7%90%86"><span class="toc-number">10.</span> <span class="toc-text"> 右键菜单原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E4%BF%9D%E5%AD%98%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-number">11.</span> <span class="toc-text"> 自动保存实现方案</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dom%E5%85%83%E7%B4%A0%E6%88%AA%E5%9B%BE%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-number">12.</span> <span class="toc-text"> DOM 元素截图实现方案</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E7%BB%B4%E7%A0%81%E7%94%9F%E6%88%90%E6%96%B9%E6%A1%88"><span class="toc-number">13.</span> <span class="toc-text"> 二维码生成方案</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">14.</span> <span class="toc-text"> 复制功能实现原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6%E5%8E%9F%E7%90%86"><span class="toc-number">15.</span> <span class="toc-text"> 下载文件原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">16.</span> <span class="toc-text"> 应用部署的流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#webpack%E6%9E%84%E5%BB%BA%E4%BC%98%E5%8C%96"><span class="toc-number">17.</span> <span class="toc-text"> webpack 构建优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bundler"><span class="toc-number">17.0.1.</span> <span class="toc-text"> Bundler：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#loaders"><span class="toc-number">17.0.2.</span> <span class="toc-text"> Loaders：</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">17.0.2.0.0.1.</span> <span class="toc-text"> 原理</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#plugins"><span class="toc-number">17.0.3.</span> <span class="toc-text"> plugins:</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-2"><span class="toc-number">17.0.3.0.0.1.</span> <span class="toc-text"> 原理</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">17.0.4.</span> <span class="toc-text"> 总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#node%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6"><span class="toc-number">18.</span> <span class="toc-text"> node 后端框架</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nodejs%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6%E8%B0%83%E7%A0%94"><span class="toc-number">18.1.</span> <span class="toc-text"> Node.js 后端框架调研</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#express"><span class="toc-number">18.1.0.1.</span> <span class="toc-text"> Express</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#koa2"><span class="toc-number">18.1.0.2.</span> <span class="toc-text"> Koa2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#eggjs"><span class="toc-number">18.1.0.3.</span> <span class="toc-text"> egg.js</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nestjs"><span class="toc-number">18.1.0.4.</span> <span class="toc-text"> Nest.js</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#vueconfigjs"><span class="toc-number">19.</span> <span class="toc-text"> vue.config.js</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA%E4%BC%98%E5%8C%96"><span class="toc-number">20.</span> <span class="toc-text"> 项目构建优化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E8%BF%90%E8%A1%8C%E4%BC%98%E5%8C%96"><span class="toc-number">21.</span> <span class="toc-text"> 项目运行优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B8%B2%E6%9F%93"><span class="toc-number">21.0.1.</span> <span class="toc-text"> 客户端渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93"><span class="toc-number">21.0.2.</span> <span class="toc-text"> 服务端渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%9E%84%E6%B8%B2%E6%9F%93"><span class="toc-number">21.0.3.</span> <span class="toc-text"> 同构渲染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssg%E9%A2%84%E6%B8%B2%E6%9F%93"><span class="toc-number">21.0.4.</span> <span class="toc-text"> SSG 预渲染</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E4%B8%8Ehttp%E4%BC%98%E5%8C%96"><span class="toc-number">22.</span> <span class="toc-text"> 部署与 HTTP 优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-number">22.0.1.</span> <span class="toc-text"> 部署</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">22.0.2.</span> <span class="toc-text"> Nginx: 反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http%E7%BC%93%E5%AD%98"><span class="toc-number">22.0.3.</span> <span class="toc-text"> HTTP 缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%8B%E7%BC%A9%E7%AE%97%E6%B3%95"><span class="toc-number">22.0.4.</span> <span class="toc-text"> 压缩算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gzip"><span class="toc-number">22.0.4.1.</span> <span class="toc-text"> gzip</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#brotli"><span class="toc-number">22.0.4.2.</span> <span class="toc-text"> Brotli</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http%E4%BC%98%E5%8C%96"><span class="toc-number">22.0.5.</span> <span class="toc-text"> HTTP 优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#keepalive%E5%B1%9E%E6%80%A7"><span class="toc-number">22.0.5.1.</span> <span class="toc-text"> keepAlive 属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#http2"><span class="toc-number">22.0.5.2.</span> <span class="toc-text"> HTTP2</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mongodb%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">23.</span> <span class="toc-text"> Mongodb 数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">23.0.1.</span> <span class="toc-text"> 基本操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mongodb%E9%AB%98%E7%BA%A7"><span class="toc-number">23.0.2.</span> <span class="toc-text"> mongodb 高级</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-number">23.0.2.0.1.</span> <span class="toc-text"> 索引</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%81%9A%E5%90%88"><span class="toc-number">23.0.2.0.2.</span> <span class="toc-text"> 聚合</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E8%A1%A8%E8%81%94%E6%9F%A5"><span class="toc-number">23.0.2.0.3.</span> <span class="toc-text"> 多表联查</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="toc-number">23.0.3.</span> <span class="toc-text"> 数据库设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="toc-number">23.0.4.</span> <span class="toc-text"> 访问权限管理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mongoose"><span class="toc-number">24.</span> <span class="toc-text"> Mongoose</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#orm"><span class="toc-number">24.0.1.</span> <span class="toc-text"> ORM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#odm"><span class="toc-number">24.0.2.</span> <span class="toc-text"> ODM</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#egg-mongoose"><span class="toc-number">25.</span> <span class="toc-text"> egg-mongoose</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#stream"><span class="toc-number">26.</span> <span class="toc-text"> Stream</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">26.0.1.</span> <span class="toc-text"> 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pipe"><span class="toc-number">26.0.2.</span> <span class="toc-text"> pipe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-3"><span class="toc-number">26.0.3.</span> <span class="toc-text"> 原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pipeline"><span class="toc-number">26.0.4.</span> <span class="toc-text"> pipeline</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">27.</span> <span class="toc-text"> 对象存储服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91oss"><span class="toc-number">27.0.1.</span> <span class="toc-text"> 阿里云 OSS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E7%89%9B%E4%BA%91kodo"><span class="toc-number">27.0.2.</span> <span class="toc-text"> 七牛云 KODO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%85%BE%E8%AE%AF%E4%BA%91cos"><span class="toc-number">27.0.3.</span> <span class="toc-text"> 腾讯云 COS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ssr%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B8%B2%E6%9F%93"><span class="toc-number">28.</span> <span class="toc-text"> SSR 服务端渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-2"><span class="toc-number">28.0.1.</span> <span class="toc-text"> 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ssr"><span class="toc-number">28.0.2.</span> <span class="toc-text"> SSR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vue%E4%B8%ADssr"><span class="toc-number">28.0.3.</span> <span class="toc-text"> vue 中 SSR</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#rbac%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81"><span class="toc-number">29.</span> <span class="toc-text"> RBAC 权限验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-3"><span class="toc-number">29.0.1.</span> <span class="toc-text"> 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">29.0.2.</span> <span class="toc-text"> 使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#casl%E4%BD%BF%E7%94%A8"><span class="toc-number">29.0.3.</span> <span class="toc-text"> Casl 使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-2"><span class="toc-number">30.</span> <span class="toc-text"> 部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E6%A8%A1%E5%BC%8F"><span class="toc-number">30.0.1.</span> <span class="toc-text"> 传统模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cluster%E6%A8%A1%E5%9E%8B"><span class="toc-number">30.0.2.</span> <span class="toc-text"> Cluster 模型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">31.</span> <span class="toc-text"> 云服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%AD%E4%B9%B0"><span class="toc-number">31.0.0.1.</span> <span class="toc-text"> 购买</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95"><span class="toc-number">31.0.0.2.</span> <span class="toc-text"> 登录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-2"><span class="toc-number">31.0.0.3.</span> <span class="toc-text"> 使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%A1%E7%90%86"><span class="toc-number">31.0.0.4.</span> <span class="toc-text"> 管理</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E9%83%A8%E7%BD%B2"><span class="toc-number">32.</span> <span class="toc-text"> 普通部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#docker"><span class="toc-number">32.1.</span> <span class="toc-text"> Docker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-4"><span class="toc-number">32.1.1.</span> <span class="toc-text"> 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-images"><span class="toc-number">32.1.2.</span> <span class="toc-text"> Docker  images</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-container"><span class="toc-number">32.1.3.</span> <span class="toc-text"> Docker Container</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE"><span class="toc-number">32.1.4.</span> <span class="toc-text"> 持久化容器数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dockerfile%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F"><span class="toc-number">32.1.5.</span> <span class="toc-text"> Dockerfile 自定义镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">32.1.6.</span> <span class="toc-text"> 数据库配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E9%95%9C%E5%83%8F%E5%A4%A7%E5%B0%8F"><span class="toc-number">32.1.7.</span> <span class="toc-text"> 优化镜像大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-3"><span class="toc-number">32.1.8.</span> <span class="toc-text"> 部署</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#yaml%E8%AF%AD%E8%A8%80"><span class="toc-number">33.</span> <span class="toc-text"> YAML 语言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#github-action"><span class="toc-number">34.</span> <span class="toc-text"> Github Action</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2"><span class="toc-number">35.</span> <span class="toc-text"> 自动化部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A8%E9%80%81%E8%BF%9C%E7%A8%8B%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="toc-number">35.1.</span> <span class="toc-text"> 推送远程镜像仓库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#github-actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">35.2.</span> <span class="toc-text"> Github Actions 自动部署</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9C%A8github%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8Abuild-image%E5%B9%B6%E4%B8%94push"><span class="toc-number">35.2.0.0.0.1.</span> <span class="toc-text"> 在 github 服务器上 build image 并且 push</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li class="active"><a href="/2024/04/12/%E5%A4%8D%E6%9D%82%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E4%B8%8A%E7%BA%BF/" rel="bookmark" title="复杂业务部署与优化">复杂业务部署与优化</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="dmq"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">dmq</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">79</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">59</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">98</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RtcTA/dGFiPXJlcG9zaXRvcmllcw==" title="https:&#x2F;&#x2F;github.com&#x2F;dmq0?tab&#x3D;repositories"><i class="ic i-github"></i></span>
      <span class="exturl item npm" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL35kbXEwMDA=" title="https:&#x2F;&#x2F;www.npmjs.com&#x2F;~dmq000"><i class="ic i-file"></i></span>
      <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9kLTg4LTYxLTgz" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;d-88-61-83"><i class="ic i-zhihu"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTgwMjc4OTk0OTE=" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;8027899491"><i class="ic i-cloud-music"></i></span>
      <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vdS83NjI1OTAxNzE3" title="https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;7625901717"><i class="ic i-weibo"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOjMyNjc4MDc1MTRAcXEuY29t" title="mailto:3267807514@qq.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>介绍</a>
  </li>

    
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

    
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

    
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a>
  </li>

    
  <li class="item">
    <a href="/links/" rel="section"><i class="ic i-magic"></i>工具</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2024/03/30/jest/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2024/04/12/%E8%84%9A%E6%89%8B%E6%9E%B6/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/HTTP/" title="分类于 HTTP">HTTP</a>
</div>

    <span><a href="/2023/05/02/HTTP/" title="HTTP">HTTP</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/webpack/" title="分类于 webpack">webpack</a>
</div>

    <span><a href="/2023/10/21/webpack/" title="webpack笔记">webpack笔记</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E6%89%8B%E5%86%99JS%E6%BA%90%E7%A0%81/" title="分类于 手写JS源码">手写JS源码</a>
</div>

    <span><a href="/2023/06/02/JS%E6%89%8B%E5%86%99/" title="手写JS源码">手写JS源码</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%84%9A%E6%89%8B%E6%9E%B6%E5%BC%80%E5%8F%91/" title="分类于 脚手架开发">脚手架开发</a>
</div>

    <span><a href="/2024/04/12/%E8%84%9A%E6%89%8B%E6%9E%B6/" title="脚手架开发">脚手架开发</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" title="分类于 正则表达式">正则表达式</a>
</div>

    <span><a href="/2024/01/10/%E6%AD%A3%E5%88%99/" title="正则理念">正则理念</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/markdown/" title="分类于 markdown">markdown</a>
</div>

    <span><a href="/2023/02/10/md/" title="markdown">markdown</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" title="分类于 自动化测试">自动化测试</a>
</div>

    <span><a href="/2024/03/02/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95/" title="自动化测试">自动化测试</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/json-server/" title="分类于 json-server">json-server</a>
</div>

    <span><a href="/2023/01/09/json-server%E6%95%99%E7%A8%8B/" title="json-server">json-server</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%84%9A%E6%89%8B%E6%9E%B6%E5%BC%80%E5%8F%91/" title="分类于 脚手架开发">脚手架开发</a>
</div>

    <span><a href="/2024/03/30/%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%E9%93%BE%E6%8E%A5/" title="本地文件链接">本地文件链接</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a>
</div>

    <span><a href="/2023/06/02/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" title="图片上传解决方案">图片上传解决方案</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">dmq @ Web blog</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2024/04/12/复杂项目部署上线/',
    favicon: {
      show: "科技引领未来",
      hide: "欢迎与我交流"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//gcore.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>


  <script data-pjax>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?9ba187659e850a6910681214f0faa16b";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</body>
</html>
