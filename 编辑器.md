## MAML 概述

- MAML 引擎脚本语言 MIUI Application Markup Language for MORE （MIUI MORE 引擎应用标记语言）

- 使用xml的方式描述静态界面和动态属性，UI在时间线上进行刷新。

- 概述 最初用于百变锁屏，使用 xml 用特定的语法描述锁屏界面。后来不断增强功能，逐步演化成一套接近通用的界面描述语言和图形渲染引擎，在一定需求下可用于开发风格多变的用户界面。可方便地通过更换皮肤改变界面风格、动画甚至交互方式。

  MAML 语言和 Android 的界面描述 xml 类似. 所不同的是 Android 描述的是静态界面，对界面元素的更改依赖 java 代码。MAML 描述的是静态界面+动态属性，UI 在时间线上按一定的帧率不断刷新，UI 显示根据元素属性的变量表达式的计算结果实时更新。MAML 语言和运行时引擎已经从锁屏中独立出来作为 MIUI 内置的通用框架，除了显示时间日期等，还支持查询标准 Content Provider 来获取各种信息如天气。显示图片文本等各种元素，各种动画，滑动点击等界面交互控件，适于实现展示信息或有简单交互操作的界面。比如时钟、天气小部件、闹钟响铃界面。

  框架支持动态帧率，不必按照固定帧率不停渲染，在没有动画和更新的时侯停止渲染，此时仅占用极少资源，对于缓慢变化的动画使用低帧率渲染，高动态的动画开始后立即调整到高帧率全速渲染。全速渲染时全屏帧率基本可以达到 60-120 帧。合理使用可以既炫酷又不费电。

# 背景

## 需求

- 小部件的设计师非常依赖于我们提供的主题编辑器进行设计和简单的制作，但是创意部分的需求需要更多可视化的支持和实现。

## 问题

- 现有的编辑器维护困难，一方面是底层技术导致的维护困难，另一方面是大版本升级时的维护难，会面临主题内容丢失的严重风险
- 编辑器不支持实时预览等功能，制作成本较高

## 资源整合利用

- 主题设计师生态和工具等资源可供更多部门使用，促进资源整合，比如可穿戴部门以往输出更多个性化表盘

# 价值

- 编辑器工具进入可维护状态，支持可视化操作，为精品内容和乍现的灵感来源提供工具支持
- 优化主题制作流程，提高内容质量，提高审核人员效率
- 降低设计师使用成本，让设计师专注于创作本身，利于设计师产出高质量作品，保存日常灵感并易于分享
- 主题已有的设计师生态、工具等资源可供兄弟部门个性化装扮时复用，实现资源的循环利用
- 生成基础组件模板，提高编写效率

# 目标

- 重构编辑器，编辑器进入可维护的正常生命周期中
- 工具使用体验提升：支持实时预览，支持maml可视化动画设计，易于上手，制作便捷
- 工具本身可以提供其他个性化装扮复用

# 结果

- 发布新版主题编辑器，覆盖80%+的主题设计师使用
- 使用该编辑器制作的主题的审核通过率提升70%（之前通过率为50%），主题审核评分高于原主题40%
- 整合maml能力并实现可视化maml，并且maml能力可以复用

# 大方向

## 功能：

- 主题编辑器

  - 应用到手机
  - 导出mtz包
  - 保存工程文件

- 全局制作

  - 实时预览
  - 可视化操作区

- maml相关

  - 可视化操作区+实时预览（支持不同状态切换预览）
    - 屏幕分辨率、不同机型、时间变化、电池多状态、锁屏多状态、消息通知、指纹开启/关闭状态等实时展示maml渲染效果
  - 支持交互预览
    - 点击、滑动、随时间变化等效果实时预览

  - Aod、百变锁屏、图标、桌面小部件、桌面、自定义（表盘）

## 事项：

- 自动生成预览页展示图，用于详情页，替代原截图及服务
- 账号信息：头像+小米id登录，非设计师无法使用
- 发布：一键上传设计师站，用户使用反馈、主题包纠错校验，主题包智能改错

# 技术方案

## 技术栈

- electron+Vue3

- 模板部分：
  - 定义新版编辑器模板格式，解析并渲染到canvas，达到编辑区实时预览
- Maml插件：
  - 定义插件渲染到画布的中间格式，接入动画编辑器能力
- parser子模块：已有基础：theme-xml-parser
- renderer：https://antv-g.gitee.io/zh/docs/guide/introduce

